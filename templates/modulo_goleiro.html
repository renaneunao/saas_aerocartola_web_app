{% extends "base.html" %}
{% block title %}Goleiros - M√≥dulos{% endblock %}

{% block content %}
<style>
@keyframes fade-in {
    from {
        opacity: 0;
        transform: translateY(-5px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
.animate-fade-in {
    animation: fade-in 0.3s ease-out;
}
</style>
<!-- Page Header -->
<div class="text-center mb-8">
    <div class="flex items-center justify-center space-x-3 mb-4">
        <div class="p-3 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg animate-pulse-glow">
            <i class="fas fa-hand-paper text-2xl text-white"></i>
        </div>
        <h1 class="text-4xl font-bold bg-gradient-to-r from-white to-purple-200 bg-clip-text text-transparent">
            Goleiros
        </h1>
    </div>
    <div class="flex items-center justify-center space-x-2 text-dark-blue-200">
        <i class="fas fa-calendar-alt"></i>
        <span class="text-lg">Rodada {{ rodada_atual }}</span>
    </div>
</div>

<!-- Navigation -->
<div class="mb-6">
    <nav class="flex space-x-2">
        <a href="{{ url_for('modulos') }}" 
           class="inline-flex items-center px-4 py-2 text-sm font-medium text-dark-blue-300 hover:text-white hover:bg-dark-blue-700/50 rounded-lg transition-all duration-200">
            <i class="fas fa-arrow-left mr-2"></i>
            Voltar aos M√≥dulos
        </a>
        <button onclick="recalcularGoleiros()" 
                class="inline-flex items-center px-4 py-2 text-sm font-medium text-green-300 hover:text-white hover:bg-green-600/50 rounded-lg transition-all duration-200">
            <i class="fas fa-sync mr-2"></i>
            Recalcular
        </button>
    </nav>
</div>

<!-- Painel de Configura√ß√£o de Pesos -->
<div class="mb-8">
    <div class="bg-gradient-to-br from-purple-900/50 to-indigo-900/50 backdrop-blur-sm rounded-2xl border border-purple-500/50 shadow-xl overflow-hidden">
        <div class="bg-gradient-to-r from-purple-700/80 to-indigo-800/80 p-4 border-b border-purple-500/50">
            <div class="flex items-center space-x-3">
                <div class="p-2 bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg shadow-lg">
                    <i class="fas fa-cogs text-white text-lg"></i>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-white">Configura√ß√£o de Pesos</h3>
                    <p class="text-purple-200 text-sm">Ajuste os pesos espec√≠ficos para goleiros</p>
                </div>
            </div>
        </div>
        
        <form id="pesosForm" class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-purple-200">
                        FATOR_MEDIA
                    </label>
                    <input type="number" 
                           id="FATOR_MEDIA"
                           name="FATOR_MEDIA" 
                           value="{{ pesos_atuais.get('FATOR_MEDIA', 0.2) }}" 
                           step="0.1" 
                           class="w-full px-3 py-2 bg-dark-blue-800/50 border border-purple-500/50 rounded-lg text-white placeholder-dark-blue-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200">
                </div>
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-purple-200">
                        FATOR_FF
                    </label>
                    <input type="number" 
                           id="FATOR_FF"
                           name="FATOR_FF" 
                           value="{{ pesos_atuais.get('FATOR_FF', 4.5) }}" 
                           step="0.1" 
                           class="w-full px-3 py-2 bg-dark-blue-800/50 border border-purple-500/50 rounded-lg text-white placeholder-dark-blue-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200">
                </div>
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-purple-200">
                        FATOR_FD
                    </label>
                    <input type="number" 
                           id="FATOR_FD"
                           name="FATOR_FD" 
                           value="{{ pesos_atuais.get('FATOR_FD', 6.5) }}" 
                           step="0.1" 
                           class="w-full px-3 py-2 bg-dark-blue-800/50 border border-purple-500/50 rounded-lg text-white placeholder-dark-blue-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200">
                </div>
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-purple-200">
                        FATOR_SG
                    </label>
                    <input type="number" 
                           id="FATOR_SG"
                           name="FATOR_SG" 
                           value="{{ pesos_atuais.get('FATOR_SG', 1.5) }}" 
                           step="0.1" 
                           class="w-full px-3 py-2 bg-dark-blue-800/50 border border-purple-500/50 rounded-lg text-white placeholder-dark-blue-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200">
                </div>
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-purple-200">
                        FATOR_PESO_JOGO
                    </label>
                    <input type="number" 
                           id="FATOR_PESO_JOGO"
                           name="FATOR_PESO_JOGO" 
                           value="{{ pesos_atuais.get('FATOR_PESO_JOGO', 1.5) }}" 
                           step="0.1" 
                           class="w-full px-3 py-2 bg-dark-blue-800/50 border border-purple-500/50 rounded-lg text-white placeholder-dark-blue-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200">
                </div>
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-purple-200">
                        FATOR_GOL_ADVERSARIO
                    </label>
                    <input type="number" 
                           id="FATOR_GOL_ADVERSARIO"
                           name="FATOR_GOL_ADVERSARIO" 
                           value="{{ pesos_atuais.get('FATOR_GOL_ADVERSARIO', 2.0) }}" 
                           step="0.1" 
                           class="w-full px-3 py-2 bg-dark-blue-800/50 border border-purple-500/50 rounded-lg text-white placeholder-dark-blue-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200">
                </div>
            </div>
            
            <div class="flex items-center justify-between mt-6 pt-4 border-t border-purple-500/30">
                <div class="text-sm text-purple-300">
                    <i class="fas fa-info-circle mr-2"></i>
                    Altera√ß√µes ser√£o aplicadas ao recalcular
                </div>
                <div class="flex space-x-3">
                    <button type="button" onclick="salvarPesos()"
                            class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white font-medium rounded-lg transition-all duration-200 transform hover:scale-105">
                        <i class="fas fa-save mr-2"></i>
                        Salvar Pesos
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Module Content -->
<div class="bg-gradient-to-br from-dark-blue-800/50 to-dark-blue-900/50 backdrop-blur-sm rounded-2xl border border-dark-blue-700/50 shadow-2xl overflow-hidden">
    <!-- Section Header -->
    <div class="bg-gradient-to-r from-dark-blue-700/80 to-dark-blue-800/80 p-6 border-b border-dark-blue-700/50">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="p-2 bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg shadow-lg">
                    <i class="fas fa-hand-paper text-white text-xl"></i>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-white">Goleiros - Rodada {{ rodada_atual }}</h2>
                    <p class="text-dark-blue-200 text-sm">An√°lise detalhada com pesos personalizados</p>
                </div>
            </div>
            <div class="text-right">
                <div class="text-2xl font-bold text-white" id="totalRegistros">-</div>
                <div class="text-dark-blue-200 text-sm">goleiros</div>
            </div>
        </div>
    </div>

    <!-- Data Content -->
    <div id="dataContainer" class="p-6">
        <!-- Loading State com Progresso (inicialmente vis√≠vel para carregar ranking salvo) -->
        <div id="loadingState" class="text-center py-12">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-500/20 rounded-full mb-4 animate-pulse">
                <i class="fas fa-spinner fa-spin text-blue-400 text-2xl"></i>
            </div>
            <h3 class="text-lg font-semibold text-white mb-4">Calculando rankings para goleiros</h3>
            
            <!-- Barra de Progresso -->
            <div class="max-w-2xl mx-auto mb-4">
                <div class="bg-dark-blue-700/50 rounded-full h-3 overflow-hidden">
                    <div id="progressBar" class="bg-gradient-to-r from-purple-500 to-blue-500 h-full transition-all duration-300 rounded-full" style="width: 0%"></div>
                </div>
                <div class="flex justify-between items-center mt-2">
                    <span id="progressText" class="text-sm text-dark-blue-300">0%</span>
                    <span id="progressDetails" class="text-sm text-dark-blue-300">Iniciando...</span>
                </div>
            </div>
            
            <!-- Logs de Progresso -->
            <div id="progressLogs" class="max-w-2xl mx-auto mt-6 bg-dark-blue-800/50 rounded-lg p-4 text-left max-h-64 overflow-y-auto">
                <div class="space-y-2 text-sm"></div>
            </div>
        </div>
        
        <!-- Error State -->
        <div id="errorState" class="text-center py-12 hidden">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-red-500/20 rounded-full mb-4">
                <i class="fas fa-exclamation-triangle text-red-400 text-2xl"></i>
            </div>
            <h3 class="text-lg font-semibold text-white mb-2">Erro ao carregar dados</h3>
            <p class="text-dark-blue-400 mb-4" id="errorMessage"></p>
            <button onclick="carregarDados(false)" class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-medium rounded-lg transition-all duration-200">
                <i class="fas fa-redo mr-2"></i>
                Tentar Novamente
            </button>
        </div>
        
        <!-- Data Content (ser√° preenchido via JS) -->
        <div id="dataContent" class="hidden">
            <!-- Tabela para goleiros -->
            <div class="overflow-x-auto">
                <table id="tabelaGoleiros" class="w-full text-sm">
                    <thead>
                        <tr class="border-b border-dark-blue-700/50">
                            <th class="text-left py-3 px-2 text-dark-blue-200 font-medium">Rank</th>
                            <th class="text-left py-3 px-2 text-dark-blue-200 font-medium">Jogador</th>
                            <th class="text-left py-3 px-2 text-dark-blue-200 font-medium">Clube</th>
                            <th class="text-left py-3 px-2 text-dark-blue-200 font-medium">Advers√°rio</th>
                            <th class="text-center py-3 px-2 text-dark-blue-200 font-medium">Pontua√ß√£o</th>
                            <th class="text-center py-3 px-2 text-dark-blue-200 font-medium">M√©dia</th>
                            <th class="text-center py-3 px-2 text-dark-blue-200 font-medium">Jogos</th>
                            <th class="text-center py-3 px-2 text-dark-blue-200 font-medium">Peso Jogo</th>
                            <th class="text-center py-3 px-2 text-dark-blue-200 font-medium">Peso SG</th>
                            <th class="text-center py-3 px-2 text-dark-blue-200 font-medium">Pre√ßo</th>
                            <th class="text-center py-3 px-2 text-dark-blue-200 font-medium">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dados ser√£o preenchidos via JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Carregar script de c√°lculo do goleiro -->
<script src="{{ url_for('static', filename='js/calculo_goleiro.js') }}"></script>

<script>
// Fun√ß√£o para adicionar log visual
function addProgressLog(message, type = 'info') {
    const logsContainer = document.getElementById('progressLogs');
    if (!logsContainer) return;
    
    const iconMap = {
        'info': 'fa-info-circle text-blue-400',
        'success': 'fa-check-circle text-green-400',
        'warning': 'fa-exclamation-circle text-yellow-400',
        'error': 'fa-times-circle text-red-400'
    };
    
    const logItem = document.createElement('div');
    logItem.className = `text-dark-blue-200 flex items-start space-x-2 animate-fade-in`;
    logItem.innerHTML = `
        <i class="fas ${iconMap[type]} mt-1 flex-shrink-0"></i>
        <span>${message}</span>
    `;
    
    logsContainer.querySelector('.space-y-2').appendChild(logItem);
    logsContainer.scrollTop = logsContainer.scrollHeight;
}

// Fun√ß√£o para atualizar progresso
function updateProgress(percent, message) {
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const progressDetails = document.getElementById('progressDetails');
    const logMessage = document.getElementById('logMessage');
    
    if (progressBar) {
        progressBar.style.width = percent + '%';
    }
    if (progressText) {
        progressText.textContent = percent + '%';
    }
    if (progressDetails) {
        progressDetails.textContent = message;
    }
    if (logMessage) {
        logMessage.textContent = message;
    }
}

// Flag para evitar c√°lculos duplicados
let calculando = false;
let chamadaIdCounter = 0;

// Inicializar bloqueador como false no in√≠cio
if (typeof window.BLOQUEAR_CALCULO_GOLEIRO === 'undefined') {
    window.BLOQUEAR_CALCULO_GOLEIRO = false;
}

// Fun√ß√£o para carregar dados da API e fazer c√°lculos
async function carregarDados(forcarRecalculo = false) {
    console.log(`[DEBUG] üü¢ FUN√á√ÉO carregarDados CHAMADA - Arquivo: modulo_goleiro.html (ID: ${chamadaIdCounter + 1})`);
    console.trace('[DEBUG] Stack trace da chamada:');
    console.log(`[DEBUG] üîç Estado inicial do bloqueador: ${window.BLOQUEAR_CALCULO_GOLEIRO}`);
    console.log(`[DEBUG] üîç forcarRecalculo: ${forcarRecalculo}`);
    
    // Se for√ßar rec√°lculo, desativar bloqueador
    if (forcarRecalculo) {
        console.log(`[DEBUG] üîÑ For√ßar rec√°lculo solicitado, desativando bloqueador`);
        window.BLOQUEAR_CALCULO_GOLEIRO = false;
    }
    
    // Prevenir m√∫ltiplas execu√ß√µes simult√¢neas
    if (calculando) {
        console.log('[DEBUG] ‚ö†Ô∏è carregarDados j√° est√° executando, ignorando chamada duplicada');
        console.trace('[DEBUG] Stack trace da chamada duplicada:');
        return;
    }
    
    // Mostrar loader
    showLoader(forcarRecalculo ? 'Recalculando ranking de goleiros...' : 'Carregando dados de goleiros...');
    
    calculando = true;
    const chamadaId = ++chamadaIdCounter;
    let loadingState = document.getElementById('loadingState');
    let errorState = document.getElementById('errorState');
    let dataContent = document.getElementById('dataContent');
    let errorMessage = document.getElementById('errorMessage');
    const totalRegistros = document.getElementById('totalRegistros');
    
    // Se os elementos n√£o existem, significa que estamos na tela inicial - restaurar estrutura
    if (!loadingState || !errorState || !dataContent) {
        const dataContainer = document.getElementById('dataContainer');
        dataContainer.innerHTML = `
            <!-- Loading State -->
            <div id="loadingState" class="text-center py-12">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-500/20 rounded-full mb-4 animate-pulse">
                    <i class="fas fa-spinner fa-spin text-blue-400 text-2xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-white mb-2">Carregando dados...</h3>
                <p class="text-dark-blue-400">Calculando rankings para goleiros</p>
            </div>
            
            <!-- Error State -->
            <div id="errorState" class="text-center py-12 hidden">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-red-500/20 rounded-full mb-4">
                    <i class="fas fa-exclamation-triangle text-red-400 text-2xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-white mb-2">Erro ao carregar dados</h3>
                <p class="text-dark-blue-400 mb-4" id="errorMessage"></p>
                <button onclick="carregarDados(false)" class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-medium rounded-lg transition-all duration-200">
                    <i class="fas fa-redo mr-2"></i>
                    Tentar Novamente
                </button>
            </div>
            
            <!-- Data Content (ser√° preenchido via JS) -->
            <div id="dataContent" class="hidden">
                <!-- Tabela para goleiros -->
                <div class="overflow-x-auto">
                    <table id="tabelaGoleiros" class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-dark-blue-700/50">
                                <th class="text-left py-3 px-2 text-dark-blue-200 font-medium">Rank</th>
                                <th class="text-left py-3 px-2 text-dark-blue-200 font-medium">Jogador</th>
                                <th class="text-left py-3 px-2 text-dark-blue-200 font-medium">Clube</th>
                                <th class="text-left py-3 px-2 text-dark-blue-200 font-medium">Advers√°rio</th>
                                <th class="text-center py-3 px-2 text-dark-blue-200 font-medium">Pontua√ß√£o</th>
                                <th class="text-center py-3 px-2 text-dark-blue-200 font-medium">M√©dia</th>
                                <th class="text-center py-3 px-2 text-dark-blue-200 font-medium">Jogos</th>
                                <th class="text-center py-3 px-2 text-dark-blue-200 font-medium">Peso Jogo</th>
                                <th class="text-center py-3 px-2 text-dark-blue-200 font-medium">Peso SG</th>
                                <th class="text-center py-3 px-2 text-dark-blue-200 font-medium">Pre√ßo</th>
                                <th class="text-center py-3 px-2 text-dark-blue-200 font-medium">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dados ser√£o preenchidos via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        
        // Recuperar elementos ap√≥s recriar HTML
        loadingState = document.getElementById('loadingState');
        errorState = document.getElementById('errorState');
        dataContent = document.getElementById('dataContent');
        errorMessage = document.getElementById('errorMessage');
    }
    
    // Limpar logs anteriores
    const logsContainer = document.getElementById('progressLogs');
    if (logsContainer) {
        const logsSpace = logsContainer.querySelector('.space-y-2');
        if (logsSpace) {
            logsSpace.innerHTML = '';
        }
        logsContainer.classList.remove('hidden');
    }
    
    // Inicializar barra de progresso
    updateProgress(0, 'Iniciando...');
    
    // Mostrar loading
    loadingState.classList.remove('hidden');
    errorState.classList.add('hidden');
    dataContent.classList.add('hidden');
    
    updateProgress(5, 'Conectando ao servidor...');
    
    try {
        // PRIMEIRO: Verificar rapidamente se h√° ranking salvo (sem buscar todos os dados)
        if (!forcarRecalculo) {
            console.log(`[DEBUG] üîç VERIFICANDO RANKING SALVO ANTES DO FETCH (ID: ${chamadaId})`);
            updateProgress(10, 'Verificando ranking salvo...');
            addProgressLog('üîç Verificando se h√° ranking salvo...', 'info');
            
                    try {
                        const checkResponse = await fetch('/api/modulos/goleiro/verificar-ranking');
                        const checkData = await checkResponse.json();
                        
                        console.log(`[DEBUG] üîç Resultado verifica√ß√£o r√°pida:`, checkData);
                        
                        if (checkData.has_ranking) {
                            console.log(`[DEBUG] ‚úÖ‚úÖ‚úÖ RANKING SALVO ENCONTRADO NA VERIFICA√á√ÉO R√ÅPIDA (ID: ${chamadaId})`);
                            console.log(`[DEBUG] üö´üö´üö´ ATIVANDO BLOQUEADOR IMEDIATAMENTE! (ID: ${chamadaId})`);
                            
                            // ATIVAR BLOQUEADOR IMEDIATAMENTE quando detectar ranking salvo
                            window.BLOQUEAR_CALCULO_GOLEIRO = true;
                            
                            // Se tem ranking, buscar apenas os dados completos
                            updateProgress(20, 'Ranking encontrado, carregando dados...');
                            addProgressLog(`üíæ Ranking salvo encontrado! Carregando dados...`, 'success');
                        } else {
                            console.log(`[DEBUG] ‚ùå Nenhum ranking salvo na verifica√ß√£o r√°pida (ID: ${chamadaId})`);
                            // Garantir que o bloqueador N√ÉO est√° ativo se n√£o h√° ranking
                            window.BLOQUEAR_CALCULO_GOLEIRO = false;
                        }
                    } catch (checkError) {
                        console.error('[DEBUG] Erro na verifica√ß√£o r√°pida:', checkError);
                        // Se houver erro, desativar bloqueador para permitir c√°lculo
                        window.BLOQUEAR_CALCULO_GOLEIRO = false;
                    }
                } else {
                    // Se for√ßarRecalculo for true, desativar bloqueador
                    window.BLOQUEAR_CALCULO_GOLEIRO = false;
                }
        
        // VERIFICA√á√ÉO CR√çTICA: Se o bloqueador estiver ativo ap√≥s a verifica√ß√£o r√°pida, fazer fetch mas com flag
        let apenasRankingSalvo = false;
        if (!forcarRecalculo && window.BLOQUEAR_CALCULO_GOLEIRO === true) {
            console.log(`[DEBUG] üö´üö´üö´ BLOQUEADOR ATIVO AP√ìS VERIFICA√á√ÉO R√ÅPIDA - BUSCANDO APENAS RANKING SALVO (ID: ${chamadaId})`);
            apenasRankingSalvo = true;
            updateProgress(30, 'Carregando ranking salvo...');
            addProgressLog('üì° Buscando ranking salvo...', 'info');
        } else {
            console.log(`[DEBUG] üîµ IN√çCIO DO FETCH COMPLETO (ID: ${chamadaId})`);
            updateProgress(30, 'Carregando dados do servidor...');
            addProgressLog('üì° Buscando dados de atletas e configura√ß√µes...', 'info');
        }
        
        console.log(`[DEBUG] üîµ ANTES DO AWAIT FETCH (ID: ${chamadaId}) - Bloqueador: ${window.BLOQUEAR_CALCULO_GOLEIRO}, apenasRankingSalvo: ${apenasRankingSalvo}`);
        
        // Se apenasRankingSalvo for true, adicionar par√¢metro na URL para indicar ao servidor
        const url = apenasRankingSalvo ? '/api/modulos/goleiro/dados?apenas_ranking=true' : '/api/modulos/goleiro/dados';
        const response = await fetch(url);
        console.log(`[DEBUG] üîµ DEPOIS DO FETCH, ANTES DO JSON (ID: ${chamadaId})`);
        const data = await response.json();
        console.log(`[DEBUG] üîµ DEPOIS DO JSON, VERIFICANDO RANKING (ID: ${chamadaId})`);
        
        if (!response.ok) {
            throw new Error(data.error || 'Erro ao carregar dados');
        }
        
        // VERIFICA√á√ÉO IMEDIATA: Se bloqueador ativo, EXIBIR RANKING DIRETAMENTE E RETORNAR
        if (window.BLOQUEAR_CALCULO_GOLEIRO === true) {
            console.log(`[DEBUG] üö´üö´üö´ BLOQUEADOR AINDA ATIVO AP√ìS FETCH - EXIBINDO RANKING DIRETAMENTE (ID: ${chamadaId})`);
            
            // Verificar se temos ranking salvo nos dados
            if (data.ranking_salvo !== null && data.ranking_salvo !== undefined && 
                Array.isArray(data.ranking_salvo) && data.ranking_salvo.length > 0) {
                
                console.log(`[DEBUG] ‚úÖ‚úÖ‚úÖ EXIBINDO RANKING SALVO DIRETAMENTE (ID: ${chamadaId}) - ${data.ranking_salvo.length} itens`);
                updateProgress(80, 'Exibindo ranking salvo...');
                addProgressLog('üíæ Exibindo ranking salvo...', 'success');
                
                // Renderizar ranking salvo diretamente
                const resultados = data.ranking_salvo.map((r, i) => ({ ...r, rank: i + 1 }));
                renderizarTabelaGoleiros(resultados);
                
                const totalRegistrosEl = document.getElementById('totalRegistros');
                if (totalRegistrosEl) {
                    totalRegistrosEl.textContent = resultados.length;
                }
                
                updateProgress(100, 'Conclu√≠do!');
                addProgressLog(`‚ú® Ranking salvo exibido com sucesso! (${resultados.length} goleiros)`, 'success');
                
                // Esconder loading e mostrar conte√∫do
                setTimeout(() => {
                    loadingState.classList.add('hidden');
                    dataContent.classList.remove('hidden');
                    if (logsContainer) {
                        logsContainer.classList.add('hidden');
                    }
                    // Toast de sucesso
                    showToast(`‚úÖ Goleiros calculados com sucesso! (${resultados.length} jogadores)`, 'success');
                }, 500);
                
                console.log(`[DEBUG] ‚úÖ‚úÖ‚úÖ RANKING EXIBIDO - RETORNANDO IMEDIATAMENTE (ID: ${chamadaId})`);
                calculando = false;
                return; // RETORNAR IMEDIATAMENTE - N√ÉO EXECUTAR MAIS NADA
            } else {
                console.error(`[DEBUG] ‚ùå‚ùå‚ùå ERRO: Bloqueador ativo mas ranking_salvo inv√°lido! (ID: ${chamadaId})`);
                // Se bloqueador ativo mas sem ranking, desativar bloqueador e continuar
                window.BLOQUEAR_CALCULO_GOLEIRO = false;
            }
        }
        
        updateProgress(50, 'Dados carregados, verificando ranking salvo...');
        if (data.atletas && data.atletas.length) {
            addProgressLog(`‚úÖ Dados carregados: ${data.atletas.length} goleiros encontrados`, 'success');
        }
        if (data.rodada_atual) {
            addProgressLog(`üìä Rodada: ${data.rodada_atual}, Perfil Jogo: ${data.perfil_peso_jogo}, Perfil SG: ${data.perfil_peso_sg}`, 'info');
        }
        
        // Verificar se h√° ranking salvo (verificar se existe e √© um array com itens)
        // Se forcarRecalculo for true, ignorar ranking salvo
        console.log(`[DEBUG] ========== VERIFICA√á√ÉO FINAL DE RANKING SALVO (ID: ${chamadaId}) ==========`);
        console.log('[DEBUG] forcarRecalculo:', forcarRecalculo);
        console.log('[DEBUG] Ranking salvo RAW:', data.ranking_salvo);
        console.log('[DEBUG] Tipo:', typeof data.ranking_salvo);
        console.log('[DEBUG] √â null?', data.ranking_salvo === null);
        console.log('[DEBUG] √â undefined?', data.ranking_salvo === undefined);
        console.log('[DEBUG] √â array?', Array.isArray(data.ranking_salvo));
        console.log('[DEBUG] Tamanho:', data.ranking_salvo?.length);
        let temRankingSalvo = false;
        
        if (!forcarRecalculo && data.ranking_salvo !== null && data.ranking_salvo !== undefined) {
            if (Array.isArray(data.ranking_salvo) && data.ranking_salvo.length > 0) {
                temRankingSalvo = true;
                console.log(`[DEBUG] ‚úÖ‚úÖ‚úÖ RANKING SALVO CONFIRMADO (ID: ${chamadaId})`);
            } else {
                console.log(`[DEBUG] ‚ö†Ô∏è Ranking salvo inv√°lido (ID: ${chamadaId})`);
            }
        } else {
            if (forcarRecalculo) {
                console.log(`[DEBUG] ‚ö†Ô∏è forcarRecalculo=true, ignorando ranking (ID: ${chamadaId})`);
            } else {
                console.log(`[DEBUG] ‚ö†Ô∏è Ranking salvo √© null/undefined (ID: ${chamadaId})`);
            }
        }
        
        if (temRankingSalvo) {
            // Se h√° ranking salvo, apenas exibir (n√£o calcular)
            console.log(`[DEBUG] ‚úÖ‚úÖ‚úÖ ENTROU NO IF DO RANKING SALVO - BLOQUEANDO QUALQUER C√ÅLCULO (ID: ${chamadaId})`);
            
            // BLOQUEAR qualquer tentativa de c√°lculo
            window.BLOQUEAR_CALCULO_GOLEIRO = true;
            console.log(`[DEBUG] üö´ BLOQUEADOR DE C√ÅLCULO ATIVADO (ID: ${chamadaId})`);
            
            addProgressLog('üíæ Ranking salvo encontrado! Carregando resultados...', 'success');
            updateProgress(50, 'Ranking salvo encontrado!');
            addProgressLog('üíæ Ranking salvo encontrado! Exibindo resultados salvos...', 'success');
            updateProgress(80, 'Preparando dados salvos...');
            
            // Renderizar ranking salvo diretamente
            const resultados = data.ranking_salvo.map((r, i) => ({ ...r, rank: i + 1 }));
            
            updateProgress(90, 'Renderizando tabela...');
            renderizarTabelaGoleiros(resultados);
            
            const totalRegistrosEl = document.getElementById('totalRegistros');
            if (totalRegistrosEl) {
                totalRegistrosEl.textContent = resultados.length;
            }
            
            updateProgress(100, 'Conclu√≠do!');
            addProgressLog(`‚ú® Ranking salvo exibido com sucesso! (${resultados.length} goleiros)`, 'success');
            
            // Esconder loading e mostrar conte√∫do ap√≥s um pequeno delay
            setTimeout(() => {
                loadingState.classList.add('hidden');
                dataContent.classList.remove('hidden');
                if (logsContainer) {
                    logsContainer.classList.add('hidden');
                }
                // Toast de sucesso
                showToast(`‚úÖ Goleiros calculados com sucesso! (${resultados.length} jogadores)`, 'success');
            }, 500);
            
            console.log(`[DEBUG] ‚úÖ‚úÖ‚úÖ RETORNANDO - N√ÉO DEVE CALCULAR (ID: ${chamadaId})`);
            calculando = false; // Liberar flag
            console.log(`[DEBUG] ‚úÖ‚úÖ‚úÖ FLAG LIBERADA, RETORNANDO AGORA (ID: ${chamadaId})`);
            
            // Retornar e PARAR completamente
            return; // Return simples deve ser suficiente
        }
        
        // Este c√≥digo s√≥ deve executar se n√£o houver ranking salvo
        // VERIFICA√á√ÉO EXTRA: Se o bloqueador estiver ativo, N√ÉO calcular
        if (window.BLOQUEAR_CALCULO_GOLEIRO === true) {
            console.log(`[DEBUG] üö´üö´üö´ BLOQUEADOR ATIVO - C√ÅLCULO IMPEDIDO! (ID: ${chamadaId})`);
            calculando = false;
            return;
        }
        
        console.log(`[DEBUG] ‚ùå‚ùå‚ùå N√ÉO ENTROU NO IF - VAI CALCULAR (ID: ${chamadaId})`);
        console.log('[DEBUG] ‚ö†Ô∏è ATEN√á√ÉO: Se voc√™ v√™ esta mensagem, significa que o return n√£o funcionou ou n√£o h√° ranking salvo!');
        console.trace(`[DEBUG] Stack trace do c√°lculo (ID: ${chamadaId}):`);
        
        // Se n√£o tem ranking salvo, calcular automaticamente
        addProgressLog('üîÑ Nenhum ranking salvo encontrado. Iniciando c√°lculo de goleiros...', 'info');
        
        updateProgress(40, 'Calculando pontua√ß√µes...');
        addProgressLog('‚öôÔ∏è Iniciando c√°lculos de pontua√ß√£o para cada goleiro...', 'info');
        
        // Calcular rankings com progresso
        console.log(`[DEBUG] ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è INICIANDO C√ÅLCULO (ID: ${chamadaId}) - Isso N√ÉO deveria acontecer se h√° ranking salvo!`);
        console.log(`[DEBUG] ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRIANDO INST√ÇNCIA CalculoGoleiro (ID: ${chamadaId})`);
        
        // VERIFICA√á√ÉO FINAL antes de criar a inst√¢ncia
        if (window.BLOQUEAR_CALCULO_GOLEIRO === true) {
            console.log(`[DEBUG] üö´üö´üö´ BLOQUEADOR ATIVO ANTES DE CRIAR INST√ÇNCIA - CANCELANDO! (ID: ${chamadaId})`);
            calculando = false;
            return;
        }
        
        const calculo = new CalculoGoleiro(data);
        console.log(`[DEBUG] ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è INST√ÇNCIA CRIADA, INICIANDO C√ÅLCULO (ID: ${chamadaId})`);
        
        // Sobrescrever o m√©todo para mostrar progresso
        const calcularComProgresso = function(topN = 20) {
            const resultados = [];
            const total = this.atletas.length;
            let processados = 0;

            for (const atleta of this.atletas) {
                processados++;
                const resultado = this.calcularPontuacao(atleta);
                resultados.push(resultado);
                
                // Atualizar progresso a cada 5 goleiros ou no √∫ltimo
                if (processados % 5 === 0 || processados === total) {
                    const percent = 40 + Math.floor((processados / total) * 45);
                    updateProgress(percent, `Calculando goleiro ${processados}/${total}...`);
                    if (processados % 10 === 0) {
                        addProgressLog(`‚öôÔ∏è Processando goleiro ${processados}/${total}...`, 'info');
                    }
                }
            }

            resultados.sort((a, b) => b.pontuacao_total - a.pontuacao_total);
            return resultados.slice(0, topN);
        };
        
        // Usar c√°lculo com progresso
        calculo.calcularMelhoresGoleiros = calcularComProgresso.bind(calculo);
        const resultados = calculo.calcularMelhoresGoleiros(20);
        
        updateProgress(85, 'Ordenando resultados...');
        addProgressLog(`‚úÖ C√°lculo conclu√≠do: ${resultados.length} goleiros processados`, 'success');
        
        // Adicionar ranking
        resultados.forEach((resultado, index) => {
            resultado.rank = index + 1;
        });
        
        updateProgress(90, 'Salvando ranking...');
        addProgressLog('üíæ Salvando ranking no banco de dados...', 'info');
        
        // Salvar ranking no servidor
        try {
            const saveResponse = await fetch('/api/modulos/goleiro/salvar-ranking', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    ranking_data: resultados,
                    rodada_atual: data.rodada_atual,
                    configuration_id: data.configuration_id
                })
            });
            
            if (saveResponse.ok) {
                addProgressLog('‚úÖ Ranking salvo com sucesso!', 'success');
            } else {
                addProgressLog('‚ö†Ô∏è Aviso: N√£o foi poss√≠vel salvar o ranking', 'warning');
            }
        } catch (saveError) {
            console.error('Erro ao salvar ranking:', saveError);
            addProgressLog('‚ö†Ô∏è Aviso: Erro ao salvar ranking', 'warning');
        }
        
        // Atualizar total de registros (se o elemento existir)
        const totalRegistrosEl = document.getElementById('totalRegistros');
        if (totalRegistrosEl) {
            totalRegistrosEl.textContent = resultados.length;
        }
        
        updateProgress(95, 'Renderizando tabela...');
        addProgressLog('üìã Gerando tabela de resultados...', 'info');
        
        // Renderizar tabela de goleiros
        renderizarTabelaGoleiros(resultados);
        
        updateProgress(100, 'Conclu√≠do!');
        addProgressLog(`‚ú® Top ${resultados.length} goleiros exibidos com sucesso!`, 'success');
        
        // Esconder loading e mostrar conte√∫do ap√≥s um pequeno delay
        setTimeout(() => {
            loadingState.classList.add('hidden');
            dataContent.classList.remove('hidden');
            if (logsContainer) {
                logsContainer.classList.add('hidden');
            }
            // Toast de sucesso
            showToast(`‚úÖ Goleiros calculados com sucesso! (${resultados.length} jogadores)`, 'success');
        }, 500);
        
        calculando = false; // Liberar flag ao finalizar (c√°lculo normal)
        console.log('[DEBUG] ========== FINALIZANDO carregarDados (c√°lculo) ==========');
        
    } catch (error) {
        console.error('Erro ao carregar dados:', error);
        loadingState.classList.add('hidden');
        errorState.classList.remove('hidden');
        errorMessage.textContent = error.message;
        calculando = false; // Liberar flag em caso de erro
        showToast('Erro ao carregar dados de goleiros', 'error');
        console.log('[DEBUG] ========== FINALIZANDO carregarDados (erro) ==========');
    } finally {
        hideLoader();
    }
}

// Fun√ß√£o para renderizar tabela de goleiros
function renderizarTabelaGoleiros(resultados) {
    const tbody = document.querySelector('#tabelaGoleiros tbody');
    if (!tbody) {
        console.error('Tabela de goleiros n√£o encontrada');
        return;
    }
    
    tbody.innerHTML = '';
    
    resultados.forEach((jogador) => {
        const tr = document.createElement('tr');
        tr.className = `border-b border-dark-blue-700/30 hover:bg-dark-blue-800/30 transition-colors duration-200 ${jogador.rank <= 3 ? `bg-gradient-to-r ${jogador.rank == 1 ? 'from-yellow-900/20 to-yellow-800/20' : jogador.rank == 2 ? 'from-gray-800/20 to-gray-700/20' : 'from-orange-900/20 to-orange-800/20'}` : ''}`;
        
        tr.innerHTML = `
            <td class="py-4 px-2">
                ${jogador.rank <= 3 ? `
                <div class="flex items-center justify-center w-8 h-8 rounded-full ${jogador.rank == 1 ? 'bg-gradient-to-br from-yellow-400 to-yellow-500 text-yellow-900' : jogador.rank == 2 ? 'bg-gradient-to-br from-gray-300 to-gray-400 text-gray-800' : 'bg-gradient-to-br from-orange-400 to-orange-500 text-orange-900'} shadow-lg">
                    ${jogador.rank == 1 ? '<i class="fas fa-crown text-sm"></i>' : jogador.rank == 2 ? '<i class="fas fa-medal text-sm"></i>' : '<i class="fas fa-award text-sm"></i>'}
                </div>
                ` : `
                <div class="flex items-center justify-center w-8 h-8 rounded-full bg-dark-blue-700/50 text-dark-blue-200 font-bold text-sm">
                    ${jogador.rank}
                </div>
                `}
            </td>
            <td class="py-4 px-2">
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center overflow-hidden">
                        <img id="player-img-${jogador.atleta_id}" src="" alt="${jogador.apelido}" class="w-full h-full object-cover">
                        <div class="w-full h-full bg-gray-600 rounded-full flex items-center justify-center" style="display: none;">
                            <span class="text-white font-bold text-xs">${jogador.apelido.substring(0, 2)}</span>
                        </div>
                    </div>
                    <div class="w-6 h-6 rounded-full flex items-center justify-center overflow-hidden">
                        <img src="${jogador.clube_escudo_url || ''}" alt="${jogador.clube_nome}" class="w-full h-full object-cover">
                        <div class="w-full h-full bg-gray-600 rounded-full flex items-center justify-center" style="display: none;">
                            <span class="text-white font-bold text-xs">${jogador.clube_abrev}</span>
                        </div>
                    </div>
                    <div>
                        <div class="font-bold text-white">${jogador.apelido}</div>
                        <div class="text-xs text-dark-blue-400">ID: ${jogador.atleta_id}</div>
                    </div>
                </div>
            </td>
            <td class="py-4 px-2">
                <div class="font-medium text-white">${jogador.clube_nome}</div>
            </td>
            <td class="py-4 px-2">
                <div class="font-medium text-orange-300">${jogador.adversario_nome || 'N/A'}</div>
            </td>
            <td class="py-4 px-2 text-center">
                <div class="text-lg font-bold ${jogador.pontuacao_total >= 10 ? 'text-green-400' : jogador.pontuacao_total >= 5 ? 'text-yellow-400' : 'text-red-400'}">
                    ${jogador.pontuacao_total.toFixed(2)}
                </div>
            </td>
            <td class="py-4 px-2 text-center">
                <div class="font-medium text-white">${jogador.media.toFixed(2)}</div>
            </td>
            <td class="py-4 px-2 text-center">
                <div class="font-medium text-white">${jogador.jogos}</div>
            </td>
            <td class="py-4 px-2 text-center">
                <div class="font-medium ${jogador.peso_jogo > 0 ? 'text-green-400' : jogador.peso_jogo < 0 ? 'text-red-400' : 'text-gray-400'}">
                    ${jogador.peso_jogo.toFixed(2)}
                </div>
            </td>
            <td class="py-4 px-2 text-center">
                <div class="font-medium ${jogador.peso_sg > 0 ? 'text-green-400' : jogador.peso_sg < 0 ? 'text-red-400' : 'text-gray-400'}">
                    ${jogador.peso_sg.toFixed(2)}
                </div>
            </td>
            <td class="py-4 px-2 text-center">
                <div class="font-medium text-green-400">R$ ${jogador.preco.toFixed(2)}</div>
            </td>
            <td class="py-4 px-2 text-center">
                <button onclick="openGoleiroModal('${jogador.atleta_id}')" 
                        class="inline-flex items-center px-3 py-1.5 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white text-xs font-medium rounded-lg transition-all duration-200 transform hover:scale-105 shadow-lg">
                    <i class="fas fa-eye mr-1"></i>
                    Detalhes
                </button>
            </td>
        `;
        
        tbody.appendChild(tr);
    });
}

// Fun√ß√£o para salvar pesos
async function salvarPesos() {
    showLoader('Salvando configura√ß√µes de pesos...');
    
    const form = document.getElementById('pesosForm');
    const formData = new FormData(form);
    
    const pesos = {};
    for (const [key, value] of formData.entries()) {
        pesos[key] = parseFloat(value);
    }
    
    try {
        const response = await fetch('/api/modulos/goleiro/pesos', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(pesos)
        });
        
        if (!response.ok) {
            throw new Error('Erro ao salvar pesos');
        }
        
        showToast('Pesos salvos com sucesso!', 'success');
        
        // Recarregar dados com novos pesos (for√ßar rec√°lculo)
        await carregarDados(true);
        
    } catch (error) {
        console.error('Erro ao salvar pesos:', error);
        showAlert('Erro ao salvar pesos: ' + error.message, 'Erro', 'error');
    } finally {
        hideLoader();
    }
}

// Fun√ß√£o para recalcular (chamada pelo bot√£o)
function recalcularGoleiros() {
    // Restaurar estrutura de containers antes de carregar
    const dataContainer = document.getElementById('dataContainer');
    if (!dataContainer.querySelector('#loadingState')) {
        dataContainer.innerHTML = `
            <!-- Loading State -->
            <div id="loadingState" class="text-center py-12">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-500/20 rounded-full mb-4 animate-pulse">
                    <i class="fas fa-spinner fa-spin text-blue-400 text-2xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-white mb-2">Carregando dados...</h3>
                <p class="text-dark-blue-400">Calculando rankings para goleiros</p>
            </div>
            
            <!-- Error State -->
            <div id="errorState" class="text-center py-12 hidden">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-red-500/20 rounded-full mb-4">
                    <i class="fas fa-exclamation-triangle text-red-400 text-2xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-white mb-2">Erro ao carregar dados</h3>
                <p class="text-dark-blue-400 mb-4" id="errorMessage"></p>
                <button onclick="carregarDados(false)" class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-medium rounded-lg transition-all duration-200">
                    <i class="fas fa-redo mr-2"></i>
                    Tentar Novamente
                </button>
            </div>
            
            <!-- Data Content (ser√° preenchido via JS) -->
            <div id="dataContent" class="hidden">
                <!-- Tabela para goleiros -->
                <div class="overflow-x-auto">
                    <table id="tabelaGoleiros" class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-dark-blue-700/50">
                                <th class="text-left py-3 px-2 text-dark-blue-200 font-medium">Rank</th>
                                <th class="text-left py-3 px-2 text-dark-blue-200 font-medium">Jogador</th>
                                <th class="text-left py-3 px-2 text-dark-blue-200 font-medium">Clube</th>
                                <th class="text-left py-3 px-2 text-dark-blue-200 font-medium">Advers√°rio</th>
                                <th class="text-center py-3 px-2 text-dark-blue-200 font-medium">Pontua√ß√£o</th>
                                <th class="text-center py-3 px-2 text-dark-blue-200 font-medium">M√©dia</th>
                                <th class="text-center py-3 px-2 text-dark-blue-200 font-medium">Jogos</th>
                                <th class="text-center py-3 px-2 text-dark-blue-200 font-medium">Peso Jogo</th>
                                <th class="text-center py-3 px-2 text-dark-blue-200 font-medium">Peso SG</th>
                                <th class="text-center py-3 px-2 text-dark-blue-200 font-medium">Pre√ßo</th>
                                <th class="text-center py-3 px-2 text-dark-blue-200 font-medium">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dados ser√£o preenchidos via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }
    carregarDados(true); // For√ßar rec√°lculo quando chamado pelo bot√£o de recalcular
}

// Carregar automaticamente ao abrir a p√°gina (primeiro tenta carregar salvo, se n√£o tiver, permite calcular)
document.addEventListener('DOMContentLoaded', function() {
    // Tentar carregar ranking salvo automaticamente (n√£o for√ßar rec√°lculo)
    carregarDados(false);
});
</script>

<!-- Modal placeholder - ser√° implementado conforme necess√°rio -->
{% endblock %}

