{% extends "base.html" %}
{% block title %}Escala√ß√£o Ideal - Cartola Aero{% endblock %}

{% block content %}
<style>
.toggle-switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 34px;
}
.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}
.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #4a5568;
    transition: .4s;
    border-radius: 34px;
}
.slider:before {
    position: absolute;
    content: "";
    height: 26px;
    width: 26px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}
input:checked + .slider {
    background-color: #10b981;
}
input:checked + .slider:before {
    transform: translateX(26px);
}
.prioridade-item {
    cursor: move;
}
.prioridade-item:hover {
    background-color: rgba(59, 130, 246, 0.1);
}
</style>

<style>
/* Override do container pai para esta p√°gina */
main > div:first-child {
    max-width: none !important;
    padding-left: 0.5rem !important;
    padding-right: 0.5rem !important;
}
</style>
<div class="py-4">
    <!-- Page Header -->
    <div class="text-center mb-8">
        <div class="flex items-center justify-center space-x-3 mb-4">
            <div class="p-3 bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-xl shadow-lg">
                <i class="fas fa-trophy text-2xl text-white"></i>
            </div>
            <h1 class="text-4xl font-bold bg-gradient-to-r from-white to-yellow-200 bg-clip-text text-transparent">
                Escala√ß√£o Ideal
            </h1>
        </div>
        <p class="text-dark-blue-200 text-lg">Configure e calcule a melhor escala√ß√£o para seu time</p>
    </div>

    <!-- Navigation -->
    <div class="mb-6">
        <nav class="flex space-x-2">
            <a href="{{ url_for('modulos') }}" 
               class="inline-flex items-center px-4 py-2 text-sm font-medium text-dark-blue-300 hover:text-white hover:bg-dark-blue-700/50 rounded-lg transition-all duration-200">
                <i class="fas fa-arrow-left mr-2"></i>
                Voltar aos M√≥dulos
            </a>
        </nav>
    </div>

    <!-- Grid de 2 colunas: Configura√ß√µes (1/4) | Resultados (3/4) -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
        
        <!-- Coluna da Esquerda: Configura√ß√µes (1 coluna) -->
        <div class="lg:col-span-1">
            <!-- Painel de Configura√ß√£o -->
            <div class="bg-gradient-to-br from-yellow-900/50 to-orange-900/50 backdrop-blur-sm rounded-2xl border border-yellow-500/50 shadow-xl overflow-hidden mb-6">
                <div class="bg-gradient-to-r from-yellow-700/80 to-orange-800/80 p-4 border-b border-yellow-500/50">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2">
                        <i class="fas fa-cogs"></i>
                        Configura√ß√µes
                    </h3>
                </div>
                
                <div class="p-4 space-y-4">
                    <!-- Forma√ß√£o -->
                    <div>
                        <label class="text-sm font-semibold text-white mb-2 block">Forma√ß√£o</label>
                        <select id="formationSelect" class="w-full px-3 py-2 bg-dark-blue-800/50 border border-yellow-500/50 rounded-lg text-white text-sm focus:outline-none focus:ring-2 focus:ring-yellow-500">
                            <option value="4-3-3">4-3-3</option>
                            <option value="4-4-2">4-4-2</option>
                            <option value="3-5-2">3-5-2</option>
                            <option value="3-4-3">3-4-3</option>
                            <option value="4-5-1">4-5-1</option>
                            <option value="5-4-1">5-4-1</option>
                        </select>
                    </div>

                    <!-- Posi√ß√£o do Capit√£o -->
                    <div>
                        <label class="text-sm font-semibold text-white mb-2 block">Posi√ß√£o do Capit√£o</label>
                        <select id="posicaoCapitao" class="w-full px-3 py-2 bg-dark-blue-800/50 border border-yellow-500/50 rounded-lg text-white text-sm focus:outline-none focus:ring-2 focus:ring-yellow-500">
                            <option value="atacantes">Atacantes</option>
                            <option value="meias">Meias</option>
                            <option value="laterais">Laterais</option>
                            <option value="zagueiros">Zagueiros</option>
                            <option value="goleiros">Goleiros</option>
                        </select>
                    </div>

                    <!-- Posi√ß√£o do Reserva de Luxo -->
                    <div>
                        <label class="text-sm font-semibold text-white mb-2 block">Posi√ß√£o do Reserva de Luxo</label>
                        <select id="posicaoReservaLuxo" class="w-full px-3 py-2 bg-dark-blue-800/50 border border-yellow-500/50 rounded-lg text-white text-sm focus:outline-none focus:ring-2 focus:ring-yellow-500">
                            <option value="atacantes">Atacantes</option>
                            <option value="meias">Meias</option>
                            <option value="laterais">Laterais</option>
                            <option value="zagueiros">Zagueiros</option>
                            <option value="goleiros">Goleiros</option>
                        </select>
                    </div>

                    <!-- Hack do Goleiro -->
                    <div class="flex items-center justify-between p-3 bg-dark-blue-800/30 rounded-lg border border-yellow-500/30">
                        <div class="flex-1 mr-3">
                            <label class="text-sm font-semibold text-white mb-1 block">Hack do Goleiro</label>
                            <p class="text-yellow-200 text-xs">Goleiro titular nulo (n√£o joga)</p>
                        </div>
                        <label class="toggle-switch flex-shrink-0">
                            <input type="checkbox" id="hackGoleiroToggle">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <!-- Fechar Defesa -->
                    <div class="flex items-center justify-between p-3 bg-dark-blue-800/30 rounded-lg border border-yellow-500/30">
                        <div class="flex-1 mr-3">
                            <label class="text-sm font-semibold text-white mb-1 block">Fechar Defesa</label>
                            <p class="text-yellow-200 text-xs">Prioriza defesa do melhor clube por SG</p>
                        </div>
                        <label class="toggle-switch flex-shrink-0">
                            <input type="checkbox" id="fecharDefesaToggle">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <!-- Ordem de Prioridades -->
                    <div>
                        <label class="text-sm font-semibold text-white mb-2 block">
                            <i class="fas fa-sort mr-1"></i>
                            Ordem de Prioridades (arraste para reordenar)
                        </label>
                        <div id="prioridadesLista" class="space-y-1">
                            <!-- Ser√° preenchido dinamicamente -->
                        </div>
                    </div>

                    <!-- Bot√µes -->
                    <div class="space-y-2 pt-4 border-t border-yellow-500/30">
                        <!-- Info: Configura√ß√µes salvas automaticamente -->
                        <div class="bg-blue-900/30 border border-blue-500/30 rounded-lg p-3 mb-3">
                            <p class="text-blue-300 text-sm text-center">
                                <i class="fas fa-info-circle mr-1"></i>
                                Configura√ß√µes salvas e recalculadas automaticamente
                            </p>
                        </div>
                        
                        <button onclick="calcularEscalacao()" id="calcularBtn" class="w-full px-4 py-3 bg-gradient-to-r from-yellow-500 to-orange-600 hover:from-yellow-600 hover:to-orange-700 text-white font-bold rounded-lg transition-all shadow-lg">
                            <i class="fas fa-calculator mr-2"></i>
                            Calcular Escala√ß√£o Ideal
                        </button>
                        <button onclick="escalarTime()" id="escalarBtn" class="w-full px-4 py-3 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold rounded-lg transition-all shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <i class="fas fa-paper-plane mr-2"></i>
                            Escalar Time no Cartola
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Coluna da Direita: Console e Resultado (3 colunas) -->
        <div class="lg:col-span-3 space-y-4">
            <!-- Informa√ß√µes do Time -->
            <div class="bg-gradient-to-br from-dark-blue-900/50 to-dark-blue-800/50 backdrop-blur-sm rounded-xl border border-dark-blue-500/50 shadow-xl p-4">
                <div id="infoInicialContent" class="flex flex-wrap items-center justify-center gap-6">
                    <div class="text-center text-gray-400 py-2">
                        <i class="fas fa-spinner fa-spin text-lg mb-1"></i>
                        <p>Carregando informa√ß√µes...</p>
                    </div>
                </div>
            </div>

            <!-- Console de Logs -->
            <div id="consolePanel" class="bg-gradient-to-br from-gray-900/90 to-gray-800/90 backdrop-blur-sm rounded-2xl border border-gray-500/50 shadow-xl overflow-hidden">
                <div class="bg-gradient-to-r from-gray-700/80 to-gray-800/80 p-4 border-b border-gray-500/50 flex items-center justify-between">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2">
                        <i class="fas fa-terminal"></i>
                        Console de C√°lculo
                    </h3>
                    <button onclick="limparConsole()" class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-sm rounded-lg transition-all">
                        <i class="fas fa-trash mr-1"></i>Limpar
                    </button>
                </div>
                <div id="progressLog" class="text-green-400 text-xs leading-relaxed p-6 bg-black/80 font-mono max-h-[400px] overflow-y-auto whitespace-pre-wrap break-words">
                    <div id="waitingMessage" class="text-gray-500">Aguardando c√°lculo...</div>
                </div>
            </div>

            <!-- Resultado da Escala√ß√£o -->
            <div id="resultadoPanel" class="hidden bg-gradient-to-br from-yellow-900/50 to-orange-900/50 backdrop-blur-sm rounded-2xl border border-yellow-500/50 shadow-xl overflow-hidden">
                <div class="bg-gradient-to-r from-yellow-700/80 to-orange-800/80 p-4 border-b border-yellow-500/50">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2">
                        <i class="fas fa-users"></i>
                        Escala√ß√£o Calculada
                    </h3>
                </div>
                <div id="escalacaoContent" class="p-6">
                    <!-- Ser√° preenchido dinamicamente -->
                </div>
            </div>

        </div>
    </div>

    <!-- Rankings Top 5 - Full Width -->
    <div class="bg-gradient-to-br from-dark-blue-900/50 to-dark-blue-800/50 backdrop-blur-sm rounded-xl border border-dark-blue-500/50 shadow-xl overflow-hidden">
        <div class="bg-gradient-to-r from-dark-blue-700/80 to-dark-blue-800/80 p-4 border-b border-dark-blue-500/50">
            <h3 class="text-lg font-bold text-white">Top 5 Rankings</h3>
            <p class="text-dark-blue-200 text-sm">Melhores jogadores e clubes por posi√ß√£o e peso</p>
        </div>
        <div id="top5CardsContent" class="p-4">
            <div class="text-center text-gray-400 py-8">
                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                <p>Carregando rankings...</p>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/escalacao_ideal.js') }}"></script>
<script src="{{ url_for('static', filename='js/calculo_escalacao.js') }}"></script>
<script>
// Estado das prioridades
let prioridadesOrdenadas = ['atacantes', 'laterais', 'meias', 'zagueiros', 'goleiros', 'treinadores'];
let configCarregada = false;

// Armazenar √∫ltima escala√ß√£o calculada
let ultimaEscalacao = null;

// Inicializar ao carregar
document.addEventListener('DOMContentLoaded', async function() {
    // Verificar se todos os m√≥dulos foram calculados
    await verificarStatusModulos();
    
    await carregarConfiguracoes();
    await carregarCardsTop5();
    renderizarPrioridades();
    configurarEventListeners();
});

// Verificar se todos os m√≥dulos de posi√ß√£o foram calculados
async function verificarStatusModulos() {
    try {
        const response = await fetch('/api/modulos/status');
        if (!response.ok) {
            throw new Error('Erro ao verificar status dos m√≥dulos');
        }
        
        const data = await response.json();
        
        if (!data.todos_calculados) {
            // M√≥dulos n√£o calculados - bloquear p√°gina
            const nomes = {
                'goleiro': 'Goleiros',
                'lateral': 'Laterais',
                'zagueiro': 'Zagueiros',
                'meia': 'Meias',
                'atacante': 'Atacantes',
                'treinador': 'T√©cnicos'
            };
            
            const modulosPendentes = Object.keys(data.status)
                .filter(m => !data.status[m])
                .map(m => nomes[m])
                .join(', ');
            
            // Mostrar alerta e redirecionar
            await showAlert(
                'M√≥dulos N√£o Calculados',
                `Voc√™ precisa calcular TODOS os m√≥dulos de posi√ß√£o antes de acessar a escala√ß√£o ideal.\n\nM√≥dulos pendentes: ${modulosPendentes}\n\nRedirecionando para a p√°gina de m√≥dulos...`
            );
            
            window.location.href = '/modulos';
            throw new Error('M√≥dulos n√£o calculados');
        }
        
        console.log('‚úÖ Todos os m√≥dulos calculados! Escala√ß√£o liberada.');
    } catch (error) {
        console.error('Erro ao verificar status:', error);
        throw error;
    }
}

// Carregar configura√ß√µes
async function carregarConfiguracoes() {
    try {
        const response = await fetch('/api/escalacao-ideal/config');
        const config = await response.json();
        
        document.getElementById('formationSelect').value = config.formation || '4-3-3';
        document.getElementById('hackGoleiroToggle').checked = config.hack_goleiro || false;
        document.getElementById('fecharDefesaToggle').checked = config.fechar_defesa || false;
        document.getElementById('posicaoCapitao').value = config.posicao_capitao || 'atacantes';
        document.getElementById('posicaoReservaLuxo').value = config.posicao_reserva_luxo || 'atacantes';
        
        // Prioridades
        if (config.prioridades) {
            // Converter 'tecnicos' para 'treinadores' se necess√°rio (migra√ß√£o)
            prioridadesOrdenadas = config.prioridades.split(',').map(p => p === 'tecnicos' ? 'treinadores' : p);
            renderizarPrioridades();
        }
        
        configCarregada = true;
    } catch (error) {
        console.error('Erro ao carregar configura√ß√µes:', error);
    }
}

// Renderizar lista de prioridades
function renderizarPrioridades() {
    const container = document.getElementById('prioridadesLista');
    const nomes = {
        'atacantes': 'Atacantes',
        'laterais': 'Laterais',
        'meias': 'Meias',
        'zagueiros': 'Zagueiros',
        'goleiros': 'Goleiros',
        'treinadores': 'T√©cnicos'
    };
    
    const icons = {
        'atacantes': 'fa-futbol',
        'laterais': 'fa-arrows-alt-h',
        'meias': 'fa-running',
        'zagueiros': 'fa-shield-alt',
        'goleiros': 'fa-hands',
        'treinadores': 'fa-clipboard-list'
    };
    
    container.innerHTML = prioridadesOrdenadas.map((pos, idx) => `
        <div class="prioridade-item flex items-center gap-3 p-2 bg-dark-blue-800/50 rounded border border-yellow-500/30" draggable="true" data-posicao="${pos}" data-index="${idx}">
            <i class="fas fa-grip-vertical text-gray-400"></i>
            <span class="flex-1 text-white text-sm flex items-center gap-2">
                <i class="fas ${icons[pos]} text-yellow-400"></i>
                ${idx + 1}. ${nomes[pos]}
            </span>
        </div>
    `).join('');
    
    // Adicionar drag and drop
    const items = container.querySelectorAll('.prioridade-item');
    items.forEach(item => {
        item.addEventListener('dragstart', handleDragStart);
        item.addEventListener('dragover', handleDragOver);
        item.addEventListener('drop', handleDrop);
        item.addEventListener('dragend', handleDragEnd);
    });
}

let draggedItem = null;

function handleDragStart(e) {
    draggedItem = this;
    this.style.opacity = '0.5';
}

function handleDragOver(e) {
    e.preventDefault();
    return false;
}

function handleDrop(e) {
    e.stopPropagation();
    if (draggedItem !== this) {
        const fromIndex = parseInt(draggedItem.dataset.index);
        const toIndex = parseInt(this.dataset.index);
        
        // Reordenar array
        const item = prioridadesOrdenadas.splice(fromIndex, 1)[0];
        prioridadesOrdenadas.splice(toIndex, 0, item);
        
        renderizarPrioridades();
    }
    return false;
}

function handleDragEnd(e) {
    this.style.opacity = '1';
}

// Salvar configura√ß√µes
async function salvarConfiguracoes() {
    const formation = document.getElementById('formationSelect').value;
    const hackGoleiro = document.getElementById('hackGoleiroToggle').checked;
    const fecharDefesa = document.getElementById('fecharDefesaToggle').checked;
    const posicaoCapitao = document.getElementById('posicaoCapitao').value;
    const posicaoReservaLuxo = document.getElementById('posicaoReservaLuxo').value;
    const prioridades = prioridadesOrdenadas.join(',');
    
    try {
        const response = await fetch('/api/escalacao-ideal/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                formation,
                hack_goleiro: hackGoleiro,
                fechar_defesa: fecharDefesa,
                posicao_capitao: posicaoCapitao,
                posicao_reserva_luxo: posicaoReservaLuxo,
                prioridades
            })
        });
        
        if (response.ok) {
            adicionarLog('‚úÖ Configura√ß√µes salvas com sucesso!', 'success');
        }
    } catch (error) {
        console.error('Erro ao salvar:', error);
        adicionarLog('‚ùå Erro ao salvar configura√ß√µes', 'error');
    }
}

// Calcular escala√ß√£o
async function calcularEscalacao() {
    const btn = document.getElementById('calcularBtn');
    btn.disabled = true;
    limparConsole();
    document.getElementById('resultadoPanel').classList.add('hidden');
    
    showLoader('Calculando escala√ß√£o ideal...');
    
    try {
        // Buscar dados
        const response = await fetch('/api/escalacao-ideal/dados');
        const dados = await response.json();
        
        if (dados.error) {
            throw new Error(dados.error);
        }
        
        // Configura√ß√µes
        const formation = document.getElementById('formationSelect').value;
        const hackGoleiro = document.getElementById('hackGoleiroToggle').checked;
        const fecharDefesa = document.getElementById('fecharDefesaToggle').checked;
        const posicaoCapitao = document.getElementById('posicaoCapitao').value;
        const posicaoReservaLuxo = document.getElementById('posicaoReservaLuxo').value;
        
        // Criar inst√¢ncia do calculador
        const escalador = new EscalacaoIdeal({
            rodada_atual: dados.rodada_atual,
            patrimonio: dados.patrimonio,
            rankings_por_posicao: dados.rankings_por_posicao,
            clubes_sg: dados.clubes_sg || [],
            formacao: formation,
            posicao_capitao: posicaoCapitao,
            posicao_reserva_luxo: posicaoReservaLuxo,
            prioridades: prioridadesOrdenadas,
            fechar_defesa: fecharDefesa,
            hack_goleiro: hackGoleiro
        });
        
        // Configurar callback de logs
        escalador.setLogCallback((msg) => adicionarLog(msg, 'log'));
        
        // Calcular
        const resultado = await escalador.calcular();
        
        // Armazenar escala√ß√£o para uso posterior
        ultimaEscalacao = resultado;
        
        // Habilitar bot√£o de escalar
        document.getElementById('escalarBtn').disabled = false;
        
        // Exibir resultado (passar clubes_dict para escudos)
        exibirResultado(resultado, dados.clubes_dict);
        
    } catch (error) {
        adicionarLog(`\n‚ùå ERRO: ${error.message}`, 'error');
        console.error(error);
        
        // Garantir que escala√ß√£o anterior √© invalidada
        ultimaEscalacao = null;
        document.getElementById('escalarBtn').disabled = true;
    } finally {
        hideLoader();
        btn.disabled = false;
    }
}

// Limpar console
function limparConsole() {
    document.getElementById('progressLog').innerHTML = '<div id="waitingMessage" class="text-gray-500">Console limpo. Aguardando c√°lculo...</div>';
}

// Adicionar log
function adicionarLog(message, tipo = 'log') {
    const logContainer = document.getElementById('progressLog');
    const waitingMessage = document.getElementById('waitingMessage');
    if (waitingMessage) waitingMessage.remove();
    
    const logEntry = document.createElement('div');
    const estilos = {
        'log': 'text-green-400',
        'info': 'text-blue-400',
        'success': 'text-green-300 font-bold',
        'error': 'text-red-400 font-bold',
        'warning': 'text-yellow-400'
    };
    
    logEntry.textContent = message;
    logEntry.className = `${estilos[tipo] || 'text-green-400'} leading-relaxed`;
    logContainer.appendChild(logEntry);
    logContainer.scrollTop = logContainer.scrollHeight;
}

// Exibir resultado
function exibirResultado(resultado, clubesDict = {}) {
    const panel = document.getElementById('resultadoPanel');
    const content = document.getElementById('escalacaoContent');
    
    // Info resumida compacta
    let html = `
        <div class="flex gap-3 mb-4">
            <div class="flex-1 bg-gradient-to-br from-yellow-600/20 to-yellow-800/20 rounded-lg px-3 py-2 border border-yellow-500/40">
                <div class="text-yellow-300 text-xs">üí∞ Custo</div>
                <div class="text-white text-lg font-bold">R$ ${resultado.custoTotal.toFixed(2)}</div>
            </div>
            <div class="flex-1 bg-gradient-to-br from-green-600/20 to-green-800/20 rounded-lg px-3 py-2 border border-green-500/40">
                <div class="text-green-300 text-xs">üìä Pontua√ß√£o</div>
                <div class="text-white text-lg font-bold">${resultado.pontuacaoTotal.toFixed(2)}</div>
            </div>
            <div class="flex-1 bg-gradient-to-br from-blue-600/20 to-blue-800/20 rounded-lg px-3 py-2 border border-blue-500/40">
                <div class="text-blue-300 text-xs">üíµ Sobra</div>
                <div class="text-white text-lg font-bold">R$ ${(resultado.patrimonio - resultado.custoTotal).toFixed(2)}</div>
            </div>
        </div>
    `;
    
    // Mapear √≠cones e nomes
    const posConfig = {
        'goleiros': { nome: 'GOL', icon: 'üß§', cor: 'bg-yellow-600/30 border-yellow-500' },
        'zagueiros': { nome: 'ZAG', icon: 'üõ°Ô∏è', cor: 'bg-blue-600/30 border-blue-500' },
        'laterais': { nome: 'LAT', icon: '‚ÜîÔ∏è', cor: 'bg-cyan-600/30 border-cyan-500' },
        'meias': { nome: 'MEI', icon: '‚ö°', cor: 'bg-purple-600/30 border-purple-500' },
        'atacantes': { nome: 'ATA', icon: '‚öΩ', cor: 'bg-red-600/30 border-red-500' },
        'treinadores': { nome: 'T√âC', icon: 'üìã', cor: 'bg-gray-600/30 border-gray-500' }
    };
    
    // Fun√ß√£o auxiliar para renderizar jogador
    const renderJogador = (j, showCusto = true, isLuxo = false) => {
        const capitao = j.eh_capitao ? '<span class="ml-1 px-1.5 py-0.5 bg-yellow-500 text-yellow-900 text-[10px] font-bold rounded">C</span>' : '';
        const luxoBadge = isLuxo ? '<span class="ml-1 px-1.5 py-0.5 bg-purple-500 text-white text-[10px] font-bold rounded">üíé LUXO</span>' : '';
        const custoText = showCusto ? `R$ ${j.preco_num?.toFixed(2)}` : '<span class="text-gray-400 text-xs">sem custo</span>';
        
        // Buscar escudo do clube no dicion√°rio
        const clube = clubesDict[j.clube_id] || {};
        const escudoUrl = clube.escudo_url || 'https://s.glbimg.com/es/sde/f/organizacoes/2018/03/10/flamengo_60x60.png';
        const escudo = `<img src="${escudoUrl}" alt="${clube.nome || ''}" class="w-5 h-5 rounded inline-block" onerror="this.style.display='none'">`;
        
        const bgColor = isLuxo ? 'bg-purple-900/40 border border-purple-500/30' : 'bg-dark-blue-900/40';
        
        return `
            <div class="flex items-start gap-2 ${bgColor} rounded px-3 py-2">
                <div class="flex-shrink-0 mt-0.5">${escudo}</div>
                <div class="flex-1 min-w-0">
                    <div class="text-white font-semibold text-sm">${j.apelido}${capitao}${luxoBadge}</div>
                    <div class="text-yellow-300 text-xs font-medium">${custoText}</div>
                </div>
            </div>
        `;
    };
    
    // TITULARES - Layout em grid por posi√ß√£o
    html += `
        <div class="bg-gradient-to-b from-green-900/20 to-dark-blue-900/30 rounded-lg p-3 mb-3 border border-green-700/30">
            <div class="flex items-center gap-2 mb-3 pb-2 border-b border-green-600/30">
                <span class="text-xl">‚≠ê</span>
                <h4 class="text-white font-bold text-sm">TIME TITULAR</h4>
            </div>
            <div class="grid grid-cols-6 gap-2">
    `;
    
    const ordem = ['goleiros', 'zagueiros', 'laterais', 'meias', 'atacantes', 'treinadores'];
    for (const pos of ordem) {
        const jogadores = resultado.titulares[pos] || [];
        if (jogadores.length > 0) {
            const config = posConfig[pos];
            html += `
                <div class="${config.cor} rounded-lg p-2 border">
                    <div class="text-center mb-2">
                        <span class="text-lg">${config.icon}</span>
                        <div class="text-white text-[10px] font-bold">${config.nome}</div>
                    </div>
                    <div class="space-y-1">
                        ${jogadores.map(j => renderJogador(j, true)).join('')}
                    </div>
                </div>
            `;
        }
    }
    
    html += '</div></div>';
    
    // RESERVAS (incluindo reserva de luxo)
    html += `
        <div class="bg-dark-blue-800/20 rounded-lg p-4 border border-dark-blue-600/30">
            <div class="flex items-center gap-2 mb-3 pb-2 border-b border-dark-blue-600/30">
                <span class="text-xl">üîÑ</span>
                <h4 class="text-white font-bold">RESERVAS</h4>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
    `;
    
    for (const pos of ordem) {
        const todosReservas = resultado.reservas[pos] || [];
        if (todosReservas.length > 0) {
            const config = posConfig[pos];
            html += `
                <div class="bg-dark-blue-900/40 rounded-lg p-3 border border-dark-blue-700">
                    <div class="flex items-center gap-2 mb-2 pb-2 border-b border-dark-blue-600">
                        <span class="text-lg">${config.icon}</span>
                        <span class="text-gray-300 text-sm font-semibold">${config.nome}</span>
                    </div>
                    <div class="space-y-2">
                        ${todosReservas.map(j => renderJogador(j, false, j.eh_reserva_luxo)).join('')}
                    </div>
                </div>
            `;
        }
    }
    
    html += '</div></div>';
    
    content.innerHTML = html;
    panel.classList.remove('hidden');
}

// Escalar time no Cartola
async function escalarTime() {
    if (!ultimaEscalacao) {
        showAlert('Calcule a escala√ß√£o ideal primeiro!', 'Aten√ß√£o', 'warning');
        return;
    }
    
    const confirmado = await showConfirm(
        'Confirma escalar este time no Cartola FC?',
        'üöÄ Escalar Time',
        { confirmText: 'Sim, escalar!', cancelText: 'Cancelar' }
    );
    
    if (!confirmado) return;
    
    const btn = document.getElementById('escalarBtn');
    const btnText = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Escalando...';
    
    showLoader('Escalando time no Cartola FC...');
    
    // Ler forma√ß√£o ATUAL do select (pode ter mudado ap√≥s o c√°lculo)
    const formacaoAtual = document.getElementById('formationSelect').value;
    
    try {
        const response = await fetch('/api/escalacao-ideal/escalar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                escalacao: ultimaEscalacao,
                formacao: formacaoAtual
            })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            adicionarLog(`\n‚úÖ ${data.mensagem}`, 'success');
            showToast('Time escalado com sucesso! Boa sorte na rodada! üçÄ', 'success', 5000);
        } else {
            const errorMsg = data.error || 'Erro desconhecido';
            adicionarLog(`\n‚ùå Erro ao escalar: ${errorMsg}`, 'error');
            
            if (data.detalhes && data.detalhes.erros) {
                const erros = Object.entries(data.detalhes.erros).map(([k, v]) => `${k}: ${v}`).join('\n');
                adicionarLog(`Detalhes:\n${erros}`, 'error');
            }
            
            showAlert(errorMsg, 'Erro ao Escalar', 'error');
        }
    } catch (error) {
        console.error('Erro ao escalar:', error);
        adicionarLog(`\n‚ùå Erro de conex√£o: ${error.message}`, 'error');
        showAlert(error.message, 'Erro de Conex√£o', 'error');
    } finally {
        hideLoader();
        btn.disabled = false;
        btn.innerHTML = btnText;
    }
}

// Configurar event listeners
function configurarEventListeners() {
    // Todos os campos de configura√ß√£o
    const configFields = [
        'formationSelect',
        'hackGoleiroToggle',
        'fecharDefesaToggle',
        'posicaoCapitao',
        'posicaoReservaLuxo',
        'prioridadesInput'
    ];
    
    // Adicionar listener para cada campo
    configFields.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            const eventType = element.type === 'checkbox' ? 'change' : 'change';
            element.addEventListener(eventType, () => {
                if (configCarregada) {
                    aoMudarConfiguracao();
                }
            });
        }
    });
}

// Fun√ß√£o chamada ao mudar qualquer configura√ß√£o
async function aoMudarConfiguracao() {
    // Invalidar escala√ß√£o anterior
    ultimaEscalacao = null;
    document.getElementById('escalarBtn').disabled = true;
    
    // Salvar configura√ß√µes
    await salvarConfiguracoes();
    
    // Recalcular automaticamente
    showToast('Configura√ß√£o alterada. Recalculando...', 'info', 2000);
    await calcularEscalacao();
}
</script>
{% endblock %}
