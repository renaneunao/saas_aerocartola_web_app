{% extends 'base.html' %}
{% block title %}Gerenciar Planos - Admin{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Cabeçalho -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-white mb-2">
                    <i class="fas fa-crown text-yellow-400 mr-2"></i>
                    Gerenciar Planos
                </h1>
                <p class="text-dark-blue-300">Altere seu plano para testar as funcionalidades</p>
            </div>
            <a href="{{ url_for('admin_classes') }}" class="inline-flex items-center px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-semibold transition-all duration-200">
                <i class="fas fa-code mr-2"></i>
                Ver Classes
            </a>
        </div>
    </div>

    <!-- Card de Plano Atual -->
    <div class="bg-gradient-to-br from-dark-blue-800/50 to-dark-blue-900/50 backdrop-blur-sm rounded-2xl border border-dark-blue-700/50 shadow-xl p-6 mb-8">
        <h2 class="text-xl font-bold text-white mb-4">
            <i class="fas fa-user-circle mr-2 text-blue-400"></i>
            Seu Plano Atual
        </h2>
        <div id="plano-atual-card" class="flex items-center justify-between p-4 bg-dark-blue-900/50 rounded-lg">
            <div class="flex items-center space-x-4">
                <div id="plano-badge" class="px-4 py-2 rounded-lg font-bold text-white">
                    <!-- Será preenchido dinamicamente -->
                </div>
                <div>
                    <p class="text-white font-semibold" id="plano-nome">Carregando...</p>
                    <p class="text-dark-blue-300 text-sm" id="plano-descricao">Aguarde...</p>
                </div>
            </div>
            <div id="plano-loading" class="text-blue-400">
                <i class="fas fa-spinner fa-spin text-2xl"></i>
            </div>
        </div>
    </div>

    <!-- Cards de Planos Disponíveis -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- Plano Free -->
        <div class="bg-gradient-to-br from-slate-800/50 to-slate-900/50 backdrop-blur-sm rounded-2xl border border-slate-700/50 shadow-xl overflow-hidden">
            <div class="p-6">
                <div class="text-center mb-4">
                    <div class="inline-block p-4 bg-slate-700/50 rounded-full mb-3">
                        <i class="fas fa-user text-3xl text-slate-400"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-white mb-1">Free</h3>
                    <p class="text-slate-400 text-sm">Plano Gratuito</p>
                </div>
                <ul class="space-y-2 mb-6 text-sm text-slate-300">
                    <li><i class="fas fa-check text-green-400 mr-2"></i>2 perfis de jogo</li>
                    <li><i class="fas fa-check text-green-400 mr-2"></i>2 perfis de SG</li>
                    <li><i class="fas fa-check text-green-400 mr-2"></i>1 time</li>
                    <li><i class="fas fa-times text-red-400 mr-2"></i>Ranking limitado</li>
                    <li><i class="fas fa-times text-red-400 mr-2"></i>Sem escalação</li>
                </ul>
                <button onclick="alterarPlano('free')" 
                        class="w-full py-2 px-4 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold transition-all duration-200">
                    Selecionar Free
                </button>
            </div>
        </div>

        <!-- Plano Avançado -->
        <div class="bg-gradient-to-br from-blue-800/50 to-blue-900/50 backdrop-blur-sm rounded-2xl border border-blue-700/50 shadow-xl overflow-hidden transform scale-105">
            <div class="absolute top-0 right-0 bg-blue-500 text-white px-3 py-1 rounded-bl-lg text-xs font-bold">
                POPULAR
            </div>
            <div class="p-6">
                <div class="text-center mb-4">
                    <div class="inline-block p-4 bg-blue-700/50 rounded-full mb-3">
                        <i class="fas fa-star text-3xl text-blue-400"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-white mb-1">Avançado</h3>
                    <p class="text-blue-400 text-sm">Recomendado</p>
                </div>
                <ul class="space-y-2 mb-6 text-sm text-blue-200">
                    <li><i class="fas fa-check text-green-400 mr-2"></i>5 perfis de jogo</li>
                    <li><i class="fas fa-check text-green-400 mr-2"></i>6 perfis de SG</li>
                    <li><i class="fas fa-check text-green-400 mr-2"></i>2 times</li>
                    <li><i class="fas fa-check text-green-400 mr-2"></i>Ranking completo</li>
                    <li><i class="fas fa-check text-green-400 mr-2"></i>Escalar 1 time</li>
                    <li><i class="fas fa-check text-green-400 mr-2"></i>Estatísticas avançadas</li>
                </ul>
                <button onclick="alterarPlano('avancado')" 
                        class="w-full py-2 px-4 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-semibold transition-all duration-200">
                    Selecionar Avançado
                </button>
            </div>
        </div>

        <!-- Plano Pro -->
        <div class="bg-gradient-to-br from-yellow-800/50 to-orange-900/50 backdrop-blur-sm rounded-2xl border border-yellow-700/50 shadow-xl overflow-hidden">
            <div class="p-6">
                <div class="text-center mb-4">
                    <div class="inline-block p-4 bg-yellow-700/50 rounded-full mb-3">
                        <i class="fas fa-crown text-3xl text-yellow-400"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-white mb-1">Pro</h3>
                    <p class="text-yellow-400 text-sm">Máximo poder</p>
                </div>
                <ul class="space-y-2 mb-6 text-sm text-yellow-200">
                    <li><i class="fas fa-check text-green-400 mr-2"></i>15 perfis de jogo</li>
                    <li><i class="fas fa-check text-green-400 mr-2"></i>10 perfis de SG</li>
                    <li><i class="fas fa-check text-green-400 mr-2"></i>Times ilimitados</li>
                    <li><i class="fas fa-check text-green-400 mr-2"></i>Editar pesos</li>
                    <li><i class="fas fa-check text-green-400 mr-2"></i>Multi-escalação</li>
                    <li><i class="fas fa-check text-green-400 mr-2"></i>Hack do goleiro</li>
                    <li><i class="fas fa-check text-green-400 mr-2"></i>Tudo liberado</li>
                </ul>
                <button onclick="alterarPlano('pro')" 
                        class="w-full py-2 px-4 bg-yellow-600 hover:bg-yellow-500 text-white rounded-lg font-semibold transition-all duration-200">
                    Selecionar Pro
                </button>
            </div>
        </div>
    </div>

    <!-- Informações de Permissões -->
    <div class="bg-gradient-to-br from-dark-blue-800/50 to-dark-blue-900/50 backdrop-blur-sm rounded-2xl border border-dark-blue-700/50 shadow-xl p-6">
        <h2 class="text-xl font-bold text-white mb-4">
            <i class="fas fa-info-circle mr-2 text-blue-400"></i>
            Permissões Detalhadas
        </h2>
        <div id="permissoes-detalhadas" class="text-dark-blue-300">
            <p class="text-center py-4">
                <i class="fas fa-spinner fa-spin mr-2"></i>
                Carregando permissões...
            </p>
        </div>
    </div>
</div>

<script>
// Carregar plano atual ao carregar a página
document.addEventListener('DOMContentLoaded', async () => {
    await carregarPlanoAtual();
    await carregarPermissoes();
});

async function carregarPlanoAtual() {
    try {
        const response = await fetch('/api/user/permissions');
        if (!response.ok) {
            throw new Error('Erro ao carregar permissões');
        }
        
        const data = await response.json();
        const planoKey = data.planKey;
        const planoName = data.plan;
        
        // Atualizar badge
        const badge = document.getElementById('plano-badge');
        const nome = document.getElementById('plano-nome');
        const descricao = document.getElementById('plano-descricao');
        const loading = document.getElementById('plano-loading');
        
        loading.style.display = 'none';
        
        const cores = {
            'free': 'bg-slate-600',
            'avancado': 'bg-blue-600',
            'pro': 'bg-yellow-600'
        };
        
        badge.className = `px-4 py-2 rounded-lg font-bold text-white ${cores[planoKey] || 'bg-slate-600'}`;
        badge.textContent = planoName;
        nome.textContent = `Plano ${planoName}`;
        descricao.textContent = `Você está usando o plano ${planoName}`;
        
    } catch (error) {
        console.error('Erro ao carregar plano:', error);
        document.getElementById('plano-loading').innerHTML = '<i class="fas fa-exclamation-triangle text-red-400"></i> Erro';
    }
}

async function carregarPermissoes() {
    try {
        const response = await fetch('/api/user/permissions');
        if (!response.ok) {
            throw new Error('Erro ao carregar permissões');
        }
        
        const data = await response.json();
        const perms = data.permissions;
        
        const container = document.getElementById('permissoes-detalhadas');
        container.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="p-4 bg-dark-blue-900/50 rounded-lg">
                    <p class="text-white font-semibold mb-2">Ranking Completo</p>
                    <p class="text-sm ${perms.rankingCompleto ? 'text-green-400' : 'text-red-400'}">
                        ${perms.rankingCompleto ? '✅ Liberado' : '❌ Bloqueado'}
                    </p>
                </div>
                <div class="p-4 bg-dark-blue-900/50 rounded-lg">
                    <p class="text-white font-semibold mb-2">Pesos de Jogo</p>
                    <p class="text-sm text-blue-400">${perms.pesosJogo} perfis disponíveis</p>
                </div>
                <div class="p-4 bg-dark-blue-900/50 rounded-lg">
                    <p class="text-white font-semibold mb-2">Pesos de SG</p>
                    <p class="text-sm text-blue-400">${perms.pesosSG} perfis disponíveis</p>
                </div>
                <div class="p-4 bg-dark-blue-900/50 rounded-lg">
                    <p class="text-white font-semibold mb-2">Editar Pesos</p>
                    <p class="text-sm ${perms.editarPesosModulos ? 'text-green-400' : 'text-red-400'}">
                        ${perms.editarPesosModulos ? '✅ Liberado' : '❌ Bloqueado'}
                    </p>
                </div>
                <div class="p-4 bg-dark-blue-900/50 rounded-lg">
                    <p class="text-white font-semibold mb-2">Escalar Time</p>
                    <p class="text-sm ${perms.podeEscalar ? 'text-green-400' : 'text-red-400'}">
                        ${perms.podeEscalar ? '✅ Liberado' : '❌ Bloqueado'}
                    </p>
                </div>
                <div class="p-4 bg-dark-blue-900/50 rounded-lg">
                    <p class="text-white font-semibold mb-2">Times Máximos</p>
                    <p class="text-sm text-blue-400">${perms.timesMaximos === 'infinite' ? 'Ilimitado' : perms.timesMaximos}</p>
                </div>
                <div class="p-4 bg-dark-blue-900/50 rounded-lg">
                    <p class="text-white font-semibold mb-2">Hack do Goleiro</p>
                    <p class="text-sm ${perms.hackGoleiro ? 'text-green-400' : 'text-red-400'}">
                        ${perms.hackGoleiro ? '✅ Liberado' : '❌ Bloqueado'}
                    </p>
                </div>
                <div class="p-4 bg-dark-blue-900/50 rounded-lg">
                    <p class="text-white font-semibold mb-2">Multi-escalação</p>
                    <p class="text-sm ${perms.multiEscalacao ? 'text-green-400' : 'text-red-400'}">
                        ${perms.multiEscalacao ? '✅ Liberado' : '❌ Bloqueado'}
                    </p>
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('Erro ao carregar permissões:', error);
        document.getElementById('permissoes-detalhadas').innerHTML = '<p class="text-red-400">Erro ao carregar permissões</p>';
    }
}

async function alterarPlano(plano) {
    if (!confirm(`Deseja alterar seu plano para ${plano.toUpperCase()}?`)) {
        return;
    }
    
    try {
        showLoader('Alterando plano...');
        
        const response = await fetch('/api/admin/alterar-plano', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ plano: plano })
        });
        
        const data = await response.json();
        
        hideLoader();
        
        if (data.success) {
            showToast('Plano alterado com sucesso!', 'success');
            // Recarregar informações
            await carregarPlanoAtual();
            await carregarPermissoes();
            // Recarregar permissões globais se existir
            if (window.planPermissions) {
                await window.planPermissions.loadPermissions();
            }
        } else {
            showToast(data.error || 'Erro ao alterar plano', 'error');
        }
    } catch (error) {
        hideLoader();
        console.error('Erro ao alterar plano:', error);
        showToast('Erro ao alterar plano', 'error');
    }
}
</script>
{% endblock %}

