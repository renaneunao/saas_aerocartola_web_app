{% extends 'base.html' %}
{% block title %}Resultados - Cartola FC Manager{% endblock %}

{% block content %}
<!-- Execution Summary (Always Visible) -->
<div class="text-center mb-6">
    <div id="executionSummaryLabel" class="inline-flex items-center space-x-4 bg-gradient-to-r from-dark-blue-800/50 to-dark-blue-900/50 backdrop-blur-sm px-6 py-3 rounded-lg border border-dark-blue-700/50">
        <div class="flex items-center space-x-2 text-dark-blue-200">
            <i class="fas fa-calendar-alt"></i>
            <span class="text-sm">Rodada <strong id="labelRodada" class="text-white">-</strong></span>
        </div>
        <div class="w-px h-4 bg-dark-blue-600"></div>
        <div class="flex items-center space-x-2 text-dark-blue-200">
            <i class="fas fa-clock"></i>
            <span class="text-sm">Última execução: <strong id="labelExecutionTime" class="text-white">-</strong></span>
        </div>
    </div>
</div>

<!-- Loading State -->
<div id="loadingMessage" class="text-center">
    <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-500/20 rounded-full mb-4">
        <i class="fas fa-spinner animate-spin text-blue-400 text-2xl"></i>
    </div>
    <h3 class="text-xl font-semibold text-white mb-2">Carregando resultados...</h3>
    <p class="text-dark-blue-300">Aguarde enquanto buscamos os dados da execução</p>
</div>

<!-- Results Content -->
<div id="resultsContent" class="hidden animate-fade-in">
    <!-- Page Header -->
    <div class="text-center mb-8">
        <div class="flex items-center justify-center space-x-3 mb-4">
            <div class="p-3 bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg animate-pulse-glow">
                <i class="fas fa-trophy text-2xl text-white"></i>
            </div>
            <h1 class="text-4xl font-bold bg-gradient-to-r from-white to-green-200 bg-clip-text text-transparent">
                Resultados da Execução
            </h1>
        </div>
        <p class="text-xl text-dark-blue-200">Análise e escalação concluídas com sucesso</p>
    </div>

    <!-- Round Information -->
    <div class="mb-8">
        <div class="bg-gradient-to-br from-blue-900/50 to-indigo-900/50 backdrop-blur-sm rounded-xl p-6 border border-blue-500/50">
            <div class="flex items-center space-x-4">
                <div class="p-3 bg-blue-500/20 rounded-lg">
                    <i class="fas fa-calendar text-blue-400 text-2xl"></i>
                </div>
                <div>
                    <h3 class="text-xl font-semibold text-white">Rodada <span id="rodadaInfo">-</span></h3>
                    <p class="text-blue-200">Execução realizada em <span id="executionTime">-</span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Teams Section -->
    <div class="mb-12">
        <div class="flex items-center space-x-3 mb-6">
            <div class="p-2 bg-gradient-to-br from-green-500 to-green-600 rounded-lg">
                <i class="fas fa-users text-white"></i>
            </div>
            <h2 class="text-2xl font-bold text-white">Times Escalados</h2>
        </div>

        <div id="timesContainer" class="grid lg:grid-cols-3 md:grid-cols-2 gap-6">
            <!-- Teams will be inserted here -->
        </div>
    </div>

    <!-- Rankings Section -->
    <div class="mb-12">
        <div class="flex items-center space-x-3 mb-6">
            <div class="p-2 bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-lg">
                <i class="fas fa-chart-bar text-white"></i>
            </div>
            <h2 class="text-2xl font-bold text-white">Rankings por Posição</h2>
        </div>

        <div id="tablesContainer" class="grid lg:grid-cols-2 gap-6">
            <!-- Tables will be inserted here -->
        </div>
    </div>

    <!-- Execution Log -->
    <div class="mb-8">
        <div class="flex items-center space-x-3 mb-6">
            <div class="p-2 bg-gradient-to-br from-gray-500 to-gray-600 rounded-lg">
                <i class="fas fa-terminal text-white"></i>
            </div>
            <h2 class="text-2xl font-bold text-white">Log de Execução</h2>
        </div>
        
        <div class="bg-gray-900/50 backdrop-blur-sm rounded-xl border border-gray-700/50 shadow-lg overflow-hidden">
            <div class="p-4 border-b border-gray-700/50">
                <h4 class="text-lg font-semibold text-gray-200">Console Output</h4>
            </div>
            <div class="p-4 max-h-96 overflow-y-auto">
                <pre id="executionLog" class="text-sm text-gray-300 whitespace-pre-wrap font-mono"></pre>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="text-center space-x-4">
        <button onclick="window.location.href='{{ url_for('pagina_inicial') }}'" 
                class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-8 py-3 rounded-lg font-semibold transition-all duration-200 transform hover:scale-105 shadow-lg">
            <i class="fas fa-redo mr-2"></i>
            Voltar à Configuração
        </button>
        
        <button onclick="window.location.href='/'" 
                class="bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white px-6 py-3 rounded-lg font-medium transition-all duration-200 transform hover:scale-105 shadow-lg">
            <i class="fas fa-home mr-2"></i>
            Voltar ao Início
        </button>
    </div>
</div>

<script>
// Date/time formatter for Brazil timezone
function formatBrDateTime(tsIso) {
    try {
        const dt = tsIso ? new Date(tsIso) : new Date();
        return new Intl.DateTimeFormat('pt-BR', {
            timeZone: 'America/Sao_Paulo',
            dateStyle: 'short',
            timeStyle: 'medium'
        }).format(dt);
    } catch (_) {
        return (tsIso ? new Date(tsIso) : new Date()).toLocaleString('pt-BR');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    loadResults();
});

async function loadResults() {
    try {
        // Try to get the latest result from backend
        const resp = await fetch('/latest_result');
        let latest = null;
        
        if (resp.status === 204) {
            latest = null;
        } else if (resp.ok) {
            try {
                latest = await resp.json();
            } catch (e) {
                latest = null;
            }
        }

        // Fallback: sessionStorage (quando os dados vierem de outro fluxo)
        const executionDataSS = JSON.parse(sessionStorage.getItem('executionData'));
        const executionOutputSS = sessionStorage.getItem('executionOutput');

        // Choose data source
        let rodada_atual = null;
        let times = null;
        let tables = null;
        let execTimeText = null;
        let execLog = null;

        if (latest && latest.last_execution_time) {
            execTimeText = formatBrDateTime(latest.last_execution_time);
            execLog = latest.output || '';
            if (latest.data) {
                rodada_atual = latest.data.rodada_atual || latest.data.rodada || null;
                times = latest.data.times || latest.data.escalacoes || null;
                tables = latest.data.tables || latest.data.rankings || null;
            }
        } else if (executionDataSS) {
            execTimeText = formatBrDateTime();
            rodada_atual = executionDataSS.rodada_atual;
            times = executionDataSS.times;
            tables = executionDataSS.tables;
            execLog = executionOutputSS || '';
        }

        if (!execTimeText) {
            const existingTime = document.getElementById('executionTime').textContent;
            const existingRodada = document.getElementById('rodadaInfo').textContent;
            execTimeText = existingTime && existingTime.trim() ? existingTime : formatBrDateTime();
            rodada_atual = existingRodada && existingRodada.trim() ? existingRodada : (rodada_atual || '-');
        }

        // Display information
        document.getElementById('executionTime').textContent = execTimeText;
        document.getElementById('rodadaInfo').textContent = rodada_atual || '-';
        
        // Update persistent label
        const labelExecEl = document.getElementById('labelExecutionTime');
        const labelRodEl = document.getElementById('labelRodada');
        if (labelExecEl) labelExecEl.textContent = execTimeText;
        if (labelRodEl) labelRodEl.textContent = rodada_atual || '-';

        // Display teams and tables if they exist
        if (times) displayTeams(times);
        if (tables) displayTables(tables);

        if (execLog) {
            document.getElementById('executionLog').textContent = execLog;
        }

        // Show results
        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('resultsContent').classList.remove('hidden');
    } catch (error) {
        showError('Erro ao carregar resultados: ' + error.message);
    }
}

function displayTeams(times) {
    const container = document.getElementById('timesContainer');
    container.innerHTML = '';

    times.forEach(time => {
        const timeCard = document.createElement('div');
        timeCard.className = 'animate-fade-in';
        timeCard.innerHTML = `
            <div class="bg-gradient-to-br from-dark-blue-800/50 to-dark-blue-900/50 backdrop-blur-sm rounded-xl border border-dark-blue-700/50 shadow-lg hover:shadow-xl transition-all duration-200 overflow-hidden">
                <!-- Team Header -->
                <div class="bg-gradient-to-r from-dark-blue-700/80 to-dark-blue-800/80 p-4 border-b border-dark-blue-700/50">
                    <h4 class="text-xl font-bold text-white text-center">${time.nome}</h4>
                    <div class="flex items-center justify-between mt-2">
                        <span class="text-dark-blue-200 text-sm">Estratégia: ${time.estrategia}</span>
                        <span class="px-3 py-1 rounded-full text-xs font-medium ${time.status === 'success' ? 'bg-green-500/20 text-green-300 border border-green-500/50' : 'bg-red-500/20 text-red-300 border border-red-500/50'}">
                            ${time.status === 'success' ? '<i class="fas fa-check-circle mr-1"></i>Sucesso' : '<i class="fas fa-exclamation-circle mr-1"></i>Erro'}
                        </span>
                    </div>
                </div>

                <div class="p-4">
                    ${time.escalacao ? generateEscalacaoHTML(time.escalacao) : '<div class="text-center py-8"><i class="fas fa-exclamation-triangle text-yellow-400 text-3xl mb-3"></i><p class="text-dark-blue-400">Nenhuma escalação disponível</p></div>'}
                </div>
            </div>
        `;
        container.appendChild(timeCard);
    });
}

function generateEscalacaoHTML(escalacao) {
    let html = '';

    // Starters
    if (escalacao.atletas && escalacao.atletas.length > 0) {
        html += `
            <div class="mb-4">
                <h5 class="text-lg font-semibold text-white mb-3 flex items-center">
                    <i class="fas fa-star text-yellow-400 mr-2"></i>
                    Titulares
                </h5>
                <div class="space-y-2">
        `;
        escalacao.atletas.forEach(atleta => {
            html += `
                <div class="flex items-center justify-between bg-dark-blue-800/30 rounded-lg p-2">
                    <div class="flex items-center space-x-2">
                        <span class="text-dark-blue-300 text-sm font-medium">${atleta.posicao}:</span>
                        <span class="text-white">${atleta.nome}</span>
                    </div>
                    ${atleta.eh_capitao ? '<span class="bg-yellow-500/20 text-yellow-300 px-2 py-1 rounded text-xs font-medium border border-yellow-500/50"><i class="fas fa-crown mr-1"></i>C</span>' : ''}
                </div>
            `;
        });
        html += '</div></div>';
    }

    // Reserves
    if (escalacao.reservas && escalacao.reservas.length > 0) {
        html += `
            <div class="mb-4 border-t border-dark-blue-700/50 pt-4">
                <h5 class="text-lg font-semibold text-white mb-3 flex items-center">
                    <i class="fas fa-user-friends text-blue-400 mr-2"></i>
                    Reservas
                </h5>
                <div class="space-y-2">
        `;
        escalacao.reservas.forEach(reserva => {
            html += `
                <div class="flex items-center space-x-2 bg-dark-blue-800/20 rounded-lg p-2">
                    <span class="text-dark-blue-300 text-sm font-medium">${reserva.posicao}:</span>
                    <span class="text-dark-blue-100">${reserva.nome}</span>
                </div>
            `;
        });
        html += '</div></div>';
    }

    // Luxury Reserves
    if (escalacao.reservas_luxo && escalacao.reservas_luxo.length > 0) {
        html += `
            <div class="border-t border-dark-blue-700/50 pt-4">
                <h5 class="text-lg font-semibold text-white mb-3 flex items-center">
                    <i class="fas fa-gem text-purple-400 mr-2"></i>
                    Reservas de Luxo
                </h5>
                <div class="space-y-2">
        `;
        escalacao.reservas_luxo.forEach(reserva => {
            html += `
                <div class="flex items-center space-x-2 bg-purple-900/20 rounded-lg p-2 border border-purple-500/30">
                    <span class="text-purple-300 text-sm font-medium">${reserva.posicao}:</span>
                    <span class="text-purple-100">${reserva.nome}</span>
                </div>
            `;
        });
        html += '</div></div>';
    }

    return html;
}

function displayTables(tables) {
    const container = document.getElementById('tablesContainer');
    container.innerHTML = '';

    if (!tables) {
        container.innerHTML = '<div class="col-span-full text-center py-8"><p class="text-dark-blue-400">Nenhuma tabela disponível</p></div>';
        return;
    }

    const tableConfigs = [
        { key: 'goleiros', title: 'Melhores Goleiros', icon: 'fas fa-hand-paper', color: 'green' },
        { key: 'laterais', title: 'Melhores Laterais', icon: 'fas fa-running', color: 'blue' },
        { key: 'zagueiros', title: 'Melhores Zagueiros', icon: 'fas fa-shield-alt', color: 'red' },
        { key: 'meias', title: 'Melhores Meias', icon: 'fas fa-futbol', color: 'purple' },
        { key: 'atacantes', title: 'Melhores Atacantes', icon: 'fas fa-bullseye', color: 'orange' },
        { key: 'treinadores', title: 'Melhores Treinadores', icon: 'fas fa-user-tie', color: 'indigo' }
    ];

    tableConfigs.forEach(config => {
        const tableDiv = document.createElement('div');
        tableDiv.className = 'animate-fade-in';
        tableDiv.innerHTML = `
            <div class="bg-gradient-to-br from-dark-blue-800/50 to-dark-blue-900/50 backdrop-blur-sm rounded-xl border border-dark-blue-700/50 shadow-lg">
                <div class="p-4 border-b border-dark-blue-700/50">
                    <h4 class="text-xl font-semibold text-white flex items-center">
                        <i class="${config.icon} text-${config.color}-400 mr-2"></i>
                        ${config.title}
                    </h4>
                </div>
                <div class="p-4">
                    <div class="overflow-x-auto">
                        ${tables[config.key] || '<p class="text-dark-blue-400 text-center py-4">Nenhum dado disponível</p>'}
                    </div>
                </div>
            </div>
        `;
        container.appendChild(tableDiv);
    });
}

function showError(message) {
    const loadingDiv = document.getElementById('loadingMessage');
    loadingDiv.innerHTML = `
        <div class="text-center">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-red-500/20 rounded-full mb-4">
                <i class="fas fa-exclamation-triangle text-red-400 text-2xl"></i>
            </div>
            <h3 class="text-xl font-semibold text-white mb-2">Erro ao Carregar</h3>
            <p class="text-red-300 mb-6">${message}</p>
            <button onclick="window.location.href='/'" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-all duration-200 transform hover:scale-105 shadow-lg">
                <i class="fas fa-home mr-2"></i>
                Voltar ao Início
            </button>
        </div>
    `;
}

// Custom styles for tables within the rankings
const style = document.createElement('style');
style.textContent = `
    .table {
        color: rgb(219 234 254);
    }
    .table th {
        background-color: rgba(7, 89, 133, 0.5);
        color: rgb(191 219 254);
        border-color: rgba(7, 89, 133, 0.5);
    }
    .table td {
        border-color: rgba(7, 89, 133, 0.3);
    }
    .table-striped tbody tr:nth-of-type(odd) {
        background-color: rgba(7, 89, 133, 0.2);
    }
    .table-hover tbody tr:hover {
        background-color: rgba(3, 105, 161, 0.3);
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}