{% extends "base.html" %}
{% block title %}Admin - Fotos dos Atletas{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-center mb-8">
        <div class="mb-4 md:mb-0">
            <h1 class="text-3xl font-bold text-white mb-2">Administração de Fotos dos Atletas</h1>
            <p class="text-blue-200">Selecione qual foto usar para cada atleta. Você pode selecionar várias antes de salvar.</p>
        </div>
        <div class="flex gap-4 items-center">
            <div class="relative w-full md:w-64">
                <input type="text" id="searchInput" placeholder="Buscar jogador ou clube..." 
                       class="w-full px-4 py-2 bg-dark-blue-800 border border-dark-blue-600 rounded-lg text-white focus:outline-none focus:border-blue-500 transition-colors">
                <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
            </div>
            <button id="btnSalvarTodas" onclick="salvarTodasSelecoes()" 
                    class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors font-medium hidden">
                <i class="fas fa-save mr-2"></i>
                Salvar Seleções (<span id="contadorSelecoes">0</span>)
            </button>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="text-center py-12">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-500/20 rounded-full mb-4 animate-pulse">
            <i class="fas fa-spinner fa-spin text-blue-400 text-2xl"></i>
        </div>
        <h3 class="text-lg font-semibold text-white">Carregando atletas...</h3>
    </div>

    <!-- Content -->
    <div id="content" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6" id="playersGrid">
            <!-- Cards serão inseridos aqui via JS -->
        </div>
        
        <!-- Paginação -->
        <div id="pagination" class="mt-8 flex justify-center items-center gap-4">
            <!-- Será preenchido via JS -->
        </div>
    </div>
</div>

<script>
let currentPage = 1;
let totalPages = 1;
let selecoesPendentes = {}; // {atleta_id: {foto_selecionada, excluir_todas}}

document.addEventListener('DOMContentLoaded', function() {
    loadAtletas(1);
    
    // Search functionality
    const searchInput = document.getElementById('searchInput');
    searchInput.addEventListener('input', function(e) {
        const term = e.target.value.toLowerCase();
        const cards = document.querySelectorAll('.player-card');
        
        cards.forEach(card => {
            const name = card.dataset.name.toLowerCase();
            const club = card.dataset.club.toLowerCase();
            
            if (name.includes(term) || club.includes(term)) {
                card.classList.remove('hidden');
            } else {
                card.classList.add('hidden');
            }
        });
    });
});

async function loadAtletas(page = 1) {
    try {
        document.getElementById('loadingState').classList.remove('hidden');
        document.getElementById('content').classList.add('hidden');
        
        const response = await fetch(`/api/admin/fotos-atletas?page=${page}`);
        const data = await response.json();
        
        if (data.error) throw new Error(data.error);
        
        currentPage = data.pagination.page;
        totalPages = data.pagination.pages;
        
        renderAtletas(data.atletas);
        renderPagination(data.pagination);
        
        document.getElementById('loadingState').classList.add('hidden');
        document.getElementById('content').classList.remove('hidden');
        updateContadorSelecoes();
    } catch (error) {
        console.error('Erro ao carregar atletas:', error);
        Swal.fire('Erro', 'Não foi possível carregar os atletas.', 'error');
    }
}

function renderAtletas(atletas) {
    const grid = document.getElementById('playersGrid');
    grid.innerHTML = '';
    
    atletas.forEach(atleta => {
        const card = document.createElement('div');
        card.className = 'player-card bg-dark-blue-800/50 border border-dark-blue-700 rounded-xl p-6 hover:bg-dark-blue-800 transition-colors';
        card.dataset.name = atleta.apelido;
        card.dataset.club = atleta.clube_nome;
        card.dataset.atletaId = atleta.atleta_id;
        
        // Verificar se já tem seleção pendente
        const selecaoPendente = selecoesPendentes[atleta.atleta_id];
        
        // Renderizar fotos disponíveis
        let fotosHtml = '';
        atleta.fotos.forEach((foto, index) => {
            const isSelected = selecaoPendente && selecaoPendente.foto_selecionada === foto.arquivo;
            fotosHtml += `
                <div class="flex flex-col items-center space-y-2">
                    <div class="relative">
                        <img src="${foto.url}" 
                             alt="${foto.fonte}" 
                             class="w-32 h-32 object-cover rounded-lg border-2 transition-colors cursor-pointer foto-option ${isSelected ? 'border-blue-500 ring-2 ring-blue-500' : 'border-dark-blue-600 hover:border-blue-400'}"
                             data-foto="${foto.arquivo}"
                             data-atleta-id="${atleta.atleta_id}"
                             onclick="marcarFotoSelecionada(${atleta.atleta_id}, '${foto.arquivo}', this)">
                        <div class="absolute top-2 right-2 bg-dark-blue-900/80 px-2 py-1 rounded text-xs text-white">
                            ${foto.fonte}
                        </div>
                        ${isSelected ? '<div class="absolute top-2 left-2 bg-blue-500 text-white px-2 py-1 rounded text-xs font-bold">✓ Selecionada</div>' : ''}
                    </div>
                    <button onclick="marcarFotoSelecionada(${atleta.atleta_id}, '${foto.arquivo}', this.closest('.flex').querySelector('img'))"
                            class="px-4 py-2 ${isSelected ? 'bg-blue-700' : 'bg-blue-600 hover:bg-blue-700'} text-white text-sm rounded-lg transition-colors">
                        ${isSelected ? 'Selecionada' : 'Selecionar'}
                    </button>
                </div>
            `;
        });
        
        card.innerHTML = `
            <div class="mb-4">
                <h3 class="text-white font-semibold text-lg mb-1">${atleta.apelido}</h3>
                <p class="text-sm text-gray-400">${atleta.clube_nome}</p>
            </div>
            <div class="flex flex-wrap gap-4 justify-center mb-4">
                ${fotosHtml}
            </div>
            <div class="mb-4 pt-4 border-t border-dark-blue-700">
                <div class="flex gap-2">
                    <input type="text" 
                           id="urlFoto_${atleta.atleta_id}"
                           placeholder="Cole a URL da foto aqui..." 
                           class="flex-1 px-3 py-2 bg-dark-blue-900 border border-dark-blue-600 rounded-lg text-white text-sm focus:outline-none focus:border-blue-500">
                    <button onclick="baixarFotoUrl(${atleta.atleta_id})"
                            class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white text-sm rounded-lg transition-colors">
                        <i class="fas fa-download mr-1"></i>
                        Baixar
                    </button>
                </div>
            </div>
            <div class="pt-4 border-t border-dark-blue-700">
                <button onclick="marcarExcluirTodas(${atleta.atleta_id})"
                        class="w-full px-4 py-2 ${selecaoPendente && selecaoPendente.excluir_todas ? 'bg-red-700' : 'bg-red-600/50 hover:bg-red-600'} text-red-200 text-sm rounded-lg transition-colors">
                    <i class="fas fa-trash mr-2"></i>
                    ${selecaoPendente && selecaoPendente.excluir_todas ? '✓ Marcado para excluir todas' : 'Nenhuma foto está correta (excluir todas)'}
                </button>
            </div>
        `;
        
        grid.appendChild(card);
    });
}

function renderPagination(pagination) {
    const paginationDiv = document.getElementById('pagination');
    
    if (pagination.pages <= 1) {
        paginationDiv.innerHTML = '';
        return;
    }
    
    let html = '';
    
    // Botão Anterior
    html += `
        <button onclick="loadAtletas(${pagination.page - 1})" 
                ${pagination.page === 1 ? 'disabled' : ''}
                class="px-4 py-2 bg-dark-blue-800 border border-dark-blue-600 rounded-lg text-white ${pagination.page === 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-dark-blue-700'} transition-colors">
            <i class="fas fa-chevron-left"></i>
        </button>
    `;
    
    // Números das páginas
    for (let i = 1; i <= pagination.pages; i++) {
        if (i === 1 || i === pagination.pages || (i >= pagination.page - 2 && i <= pagination.page + 2)) {
            html += `
                <button onclick="loadAtletas(${i})" 
                        class="px-4 py-2 ${i === pagination.page ? 'bg-blue-600' : 'bg-dark-blue-800 hover:bg-dark-blue-700'} border border-dark-blue-600 rounded-lg text-white transition-colors">
                    ${i}
                </button>
            `;
        } else if (i === pagination.page - 3 || i === pagination.page + 3) {
            html += `<span class="px-2 text-gray-400">...</span>`;
        }
    }
    
    // Botão Próximo
    html += `
        <button onclick="loadAtletas(${pagination.page + 1})" 
                ${pagination.page === pagination.pages ? 'disabled' : ''}
                class="px-4 py-2 bg-dark-blue-800 border border-dark-blue-600 rounded-lg text-white ${pagination.page === pagination.pages ? 'opacity-50 cursor-not-allowed' : 'hover:bg-dark-blue-700'} transition-colors">
            <i class="fas fa-chevron-right"></i>
        </button>
    `;
    
    html += `<span class="text-gray-400 ml-4">Página ${pagination.page} de ${pagination.pages} (${pagination.total} atletas)</span>`;
    
    paginationDiv.innerHTML = html;
}

function marcarFotoSelecionada(atletaId, fotoArquivo, imgElement) {
    const card = document.querySelector(`[data-atleta-id="${atletaId}"]`);
    if (!card) return;
    
    // Verificar se já está selecionada (desmarcar)
    const jaSelecionada = selecoesPendentes[atletaId] && 
                         selecoesPendentes[atletaId].foto_selecionada === fotoArquivo;
    
    if (jaSelecionada) {
        // Desmarcar
        delete selecoesPendentes[atletaId];
        
        // Remover seleção visual de todas as fotos
        card.querySelectorAll('.foto-option').forEach(img => {
            img.classList.remove('border-blue-500', 'ring-2', 'ring-blue-500');
            img.classList.add('border-dark-blue-600');
        });
        
        // Remover indicadores visuais
        card.querySelectorAll('.absolute.top-2.left-2').forEach(el => {
            if (el.textContent.includes('✓ Selecionada')) {
                el.remove();
            }
        });
        
        // Atualizar todos os botões de selecionar
        card.querySelectorAll('button').forEach(btn => {
            if (btn.textContent.includes('Selecionada') || btn.textContent.includes('Selecionar')) {
                btn.textContent = 'Selecionar';
                btn.classList.remove('bg-blue-700');
                btn.classList.add('bg-blue-600');
            }
        });
        
        // Atualizar botão de excluir todas
        const btnExcluir = card.querySelector('button[onclick*="marcarExcluirTodas"]');
        if (btnExcluir) {
            btnExcluir.textContent = 'Nenhuma foto está correta (excluir todas)';
            btnExcluir.classList.remove('bg-red-700');
            btnExcluir.classList.add('bg-red-600/50');
        }
    } else {
        // Limpar seleção de excluir todas se houver
        if (selecoesPendentes[atletaId] && selecoesPendentes[atletaId].excluir_todas) {
            delete selecoesPendentes[atletaId];
        }
        
        // Marcar foto como selecionada
        selecoesPendentes[atletaId] = {
            foto_selecionada: fotoArquivo,
            excluir_todas: false
        };
        
        // Remover seleção de todas as fotos deste atleta
        card.querySelectorAll('.foto-option').forEach(img => {
            img.classList.remove('border-blue-500', 'ring-2', 'ring-blue-500');
            img.classList.add('border-dark-blue-600');
            
            // Remover indicadores antigos
            const fotoDiv = img.closest('.relative');
            if (fotoDiv) {
                const indicador = fotoDiv.querySelector('.absolute.top-2.left-2');
                if (indicador && indicador.textContent.includes('✓ Selecionada')) {
                    indicador.remove();
                }
            }
        });
        
        // Marcar a foto selecionada
        if (imgElement) {
            imgElement.classList.remove('border-dark-blue-600');
            imgElement.classList.add('border-blue-500', 'ring-2', 'ring-blue-500');
            
            // Adicionar indicador visual
            const fotoDiv = imgElement.closest('.relative');
            if (fotoDiv) {
                const indicador = document.createElement('div');
                indicador.className = 'absolute top-2 left-2 bg-blue-500 text-white px-2 py-1 rounded text-xs font-bold';
                indicador.textContent = '✓ Selecionada';
                fotoDiv.appendChild(indicador);
            }
        }
        
        // Atualizar todos os botões de selecionar
        card.querySelectorAll('button').forEach(btn => {
            if (btn.textContent.includes('Selecionar') || btn.textContent.includes('Selecionada')) {
                const btnImg = btn.closest('.flex')?.querySelector('img');
                if (btnImg === imgElement) {
                    btn.textContent = 'Selecionada';
                    btn.classList.remove('bg-blue-600');
                    btn.classList.add('bg-blue-700');
                } else {
                    btn.textContent = 'Selecionar';
                    btn.classList.remove('bg-blue-700');
                    btn.classList.add('bg-blue-600');
                }
            }
        });
        
        // Atualizar botão de excluir todas
        const btnExcluir = card.querySelector('button[onclick*="marcarExcluirTodas"]');
        if (btnExcluir) {
            btnExcluir.textContent = 'Nenhuma foto está correta (excluir todas)';
            btnExcluir.classList.remove('bg-red-700');
            btnExcluir.classList.add('bg-red-600/50');
        }
    }
    
    updateContadorSelecoes();
}

function marcarExcluirTodas(atletaId) {
    const card = document.querySelector(`[data-atleta-id="${atletaId}"]`);
    if (!card) return;
    
    // Verificar se já está marcado (desmarcar)
    const jaMarcado = selecoesPendentes[atletaId] && selecoesPendentes[atletaId].excluir_todas;
    
    if (jaMarcado) {
        // Desmarcar
        delete selecoesPendentes[atletaId];
        
        const btn = card.querySelector('button[onclick*="marcarExcluirTodas"]');
        if (btn) {
            btn.textContent = 'Nenhuma foto está correta (excluir todas)';
            btn.classList.remove('bg-red-700');
            btn.classList.add('bg-red-600/50');
        }
    } else {
        // Limpar seleção de foto se houver
        if (selecoesPendentes[atletaId] && selecoesPendentes[atletaId].foto_selecionada) {
            delete selecoesPendentes[atletaId];
        }
        
        // Marcar para excluir todas
        selecoesPendentes[atletaId] = {
            excluir_todas: true
        };
        
        const btn = card.querySelector('button[onclick*="marcarExcluirTodas"]');
        if (btn) {
            btn.textContent = '✓ Marcado para excluir todas';
            btn.classList.remove('bg-red-600/50');
            btn.classList.add('bg-red-700');
        }
        
        // Remover seleção de todas as fotos
        card.querySelectorAll('.foto-option').forEach(img => {
            img.classList.remove('border-blue-500', 'ring-2', 'ring-blue-500');
            img.classList.add('border-dark-blue-600');
            
            // Remover indicadores visuais
            const fotoDiv = img.closest('.relative');
            if (fotoDiv) {
                const indicador = fotoDiv.querySelector('.absolute.top-2.left-2');
                if (indicador && indicador.textContent.includes('✓ Selecionada')) {
                    indicador.remove();
                }
            }
        });
        
        // Atualizar todos os botões de selecionar
        card.querySelectorAll('button').forEach(btn => {
            if (btn.textContent.includes('Selecionada') || btn.textContent.includes('Selecionar')) {
                btn.textContent = 'Selecionar';
                btn.classList.remove('bg-blue-700');
                btn.classList.add('bg-blue-600');
            }
        });
    }
    
    updateContadorSelecoes();
}

async function baixarFotoUrl(atletaId) {
    const urlInput = document.getElementById(`urlFoto_${atletaId}`);
    const url = urlInput.value.trim();
    
    if (!url) {
        Swal.fire('Atenção', 'Por favor, informe a URL da foto.', 'warning');
        return;
    }
    
    // Validar URL básica
    try {
        new URL(url);
    } catch (e) {
        Swal.fire('URL Inválida', 'Por favor, informe uma URL válida (ex: https://exemplo.com/foto.jpg)', 'warning');
        return;
    }
    
    try {
        // Mostrar loading
        Swal.fire({
            title: 'Baixando foto...',
            html: 'Aguarde enquanto a foto é baixada.<br><small>Isso pode levar até 30 segundos</small>',
            allowOutsideClick: false,
            allowEscapeKey: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        
        const response = await fetch('/api/admin/fotos-atletas/baixar-url', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                atleta_id: atletaId,
                url_foto: url
            })
        });
        
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'Erro ao baixar foto');
        }
        
        Swal.fire({
            title: 'Sucesso!',
            text: data.message || 'Foto baixada com sucesso. Recarregando...',
            icon: 'success',
            timer: 2000,
            showConfirmButton: false
        });
        
        // Limpar campo
        urlInput.value = '';
        
        // Recarregar página atual
        setTimeout(() => {
            loadAtletas(currentPage);
        }, 2000);
        
    } catch (error) {
        console.error('Erro:', error);
        let errorMessage = error.message || 'Falha ao baixar foto';
        
        // Melhorar mensagens de erro
        if (errorMessage.includes('Timeout') || errorMessage.includes('timeout')) {
            errorMessage = 'A URL demorou muito para responder. Verifique se a URL está correta e tente novamente.';
        } else if (errorMessage.includes('Connection') || errorMessage.includes('conexão')) {
            errorMessage = 'Não foi possível conectar à URL. Verifique sua conexão com a internet e se a URL está acessível.';
        } else if (errorMessage.includes('HTTP')) {
            errorMessage = 'Erro ao acessar a URL. Verifique se a URL está correta e se a imagem está acessível.';
        }
        
        Swal.fire({
            title: 'Erro ao Baixar Foto',
            html: `<p>${errorMessage}</p><small>Dica: Certifique-se de que a URL aponta diretamente para uma imagem (termina em .jpg, .png, etc.)</small>`,
            icon: 'error',
            confirmButtonText: 'OK'
        });
    }
}

function updateContadorSelecoes() {
    const count = Object.keys(selecoesPendentes).length;
    const btnSalvar = document.getElementById('btnSalvarTodas');
    const contador = document.getElementById('contadorSelecoes');
    
    contador.textContent = count;
    
    if (count > 0) {
        btnSalvar.classList.remove('hidden');
    } else {
        btnSalvar.classList.add('hidden');
    }
}

async function salvarTodasSelecoes() {
    const selecoes = Object.entries(selecoesPendentes).map(([atletaId, selecao]) => ({
        atleta_id: parseInt(atletaId),
        foto_selecionada: selecao.foto_selecionada || null,
        excluir_todas: selecao.excluir_todas || false
    }));
    
    if (selecoes.length === 0) {
        Swal.fire('Atenção', 'Nenhuma seleção para salvar.', 'info');
        return;
    }
    
    try {
        const result = await Swal.fire({
            title: 'Confirmar',
            text: `Deseja salvar ${selecoes.length} seleção(ões)?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Sim, salvar',
            cancelButtonText: 'Cancelar'
        });
        
        if (!result.isConfirmed) return;
        
        Swal.fire({
            title: 'Salvando...',
            text: 'Aguarde enquanto as seleções são processadas.',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        
        const response = await fetch('/api/admin/fotos-atletas/salvar-multiplas', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ selecoes })
        });
        
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.erros.join(', ') || 'Erro ao salvar seleções');
        }
        
        // Limpar seleções pendentes
        selecoesPendentes = {};
        updateContadorSelecoes();
        
        Swal.fire({
            title: 'Sucesso!',
            html: `${data.total_processados} seleção(ões) processada(s) com sucesso.${data.total_erros > 0 ? '<br>Erros: ' + data.total_erros : ''}`,
            icon: 'success',
            timer: 2000,
            showConfirmButton: false
        });
        
        // Recarregar página atual
        setTimeout(() => {
            loadAtletas(currentPage);
        }, 2000);
        
    } catch (error) {
        console.error('Erro:', error);
        Swal.fire('Erro', 'Falha ao salvar seleções: ' + error.message, 'error');
    }
}
</script>
{% endblock %}
